function Aabb(){this.min_=[0,0,0];this.max_=[0,0,0]}
Aabb.prototype={clone:function(){var a=new Aabb;a.min_=this.min_.slice();a.max_=this.max_.slice();return a},copy:function(a){vec3.copy(this.min_,a.min_);vec3.copy(this.max_,a.max_);return this},setCopy:function(a,b){vec3.copy(this.min_,a);vec3.copy(this.max_,b);return this},set:function(a,b,c,f,e,d){var k=this.min_,g=this.max_;k[0]=a;k[1]=b;k[2]=c;g[0]=f;g[1]=e;g[2]=d;return this},computeCenter:function(){var a=[0,0,0];return vec3.scale(a,vec3.add(a,this.min_,this.max_),0.5)},isOutside:function(a){var b=
this.min_,c=this.max_,f=a.min_;a=a.max_;return f[0]>c[0]||a[0]<b[0]||f[1]>c[1]||a[1]<b[1]||f[2]>c[2]||a[2]<b[2]?!0:!1},isInside:function(a){var b=this.min_,c=this.max_,f=a.min_;a=a.max_;return b[0]>=f[0]&&c[0]<=a[0]&&b[1]>=f[1]&&c[1]<=a[1]&&b[2]>=f[2]&&c[2]<=a[2]?!0:!1},pointInside:function(a){var b=this.min_,c=this.max_,f=a[0],e=a[1];a=a[2];return f<=b[0]||f>c[0]||e<=b[1]||e>c[1]||a<=b[2]||a>c[2]?!1:!0},expandsWithPoint:function(a,b,c){var f=this.min_,e=this.max_;a>e[0]&&(e[0]=a);a<f[0]&&(f[0]=a);
b>e[1]&&(e[1]=b);b<f[1]&&(f[1]=b);c>e[2]&&(e[2]=c);c<f[2]&&(f[2]=c)},expandsWithAabb:function(a){var b=this.min_,c=this.max_,f=a.min_,e=a.max_;a=f[0];var d=f[1],f=f[2],k=e[0],g=e[1],e=e[2];k>c[0]&&(c[0]=k);a<b[0]&&(b[0]=a);g>c[1]&&(c[1]=g);d<b[1]&&(b[1]=d);e>c[2]&&(c[2]=e);f<b[2]&&(b[2]=f)},intersectRay:function(a,b){var c=this.min_,f=this.max_,e=b[0],d=b[1],k=b[2],g=a[0],h=a[1],l=a[2],m=(c[0]-g)*e,e=(f[0]-g)*e,g=(c[1]-h)*d,d=(f[1]-h)*d,c=(c[2]-l)*k,k=(f[2]-l)*k,f=Math.max(Math.max(Math.min(m,e),
Math.min(g,d)),Math.min(c,k)),m=Math.min(Math.min(Math.max(m,e),Math.max(g,d)),Math.max(c,k));return 0<=m&&f<m},intersectSphere:function(a,b){var c=this.min_,f=this.max_,e=a[0],d=a[1],k=a[2],g=[0,0,0];g[0]=c[0]>e?c[0]:f[0]<e?f[0]:e;g[1]=c[1]>d?c[1]:f[1]<d?f[1]:d;g[2]=c[2]>k?c[2]:f[2]<k?f[2]:k;return vec3.sqrDist(a,g)<b},enlargeIfFlat:function(a){var b=this.min_,c=this.max_;b[0]===c[0]&&(b[0]-=a,c[0]+=a);b[1]===c[1]&&(b[1]-=a,c[1]+=a);b[2]===c[2]&&(b[2]-=a,c[2]+=a)}};function Camera(){this.mode_=Camera.mode.PLANE;this.type_=Camera.projType.PERSPECTIVE;this.rot_=quat.create();this.view_=mat4.create();this.proj_=mat4.create();this.lastNormalizedMouseXY_=[0,0];this.height_=this.width_=0;this.zoom_=20;this.transY_=this.transX_=0;this.speed_=1;this.moveZ_=this.moveX_=0;this.fov_=70;this.center_=[0,0,0];this.usePivot_=!1}Camera.mode={SPHERICAL:0,PLANE:1};Camera.projType={PERSPECTIVE:0,ORTHOGRAPHIC:1};
Camera.prototype={start:function(a,b,c){this.lastNormalizedMouseXY_=Geometry.normalizedMouse(a,b,this.width_,this.height_);this.usePivot_&&c.mesh_&&(vec3.transformMat4(this.center_,c.interPoint_,c.mesh_.matTransform_),this.zoom_=vec3.dist(this.center_,this.computePosition()),this.speed_=5*this.zoom_)},rotate:function(a,b){var c=Geometry.normalizedMouse(a,b,this.width_,this.height_);if(this.mode_===Camera.mode.PLANE){var f=vec2.dist(this.lastNormalizedMouseXY_,c),e=[0,0];vec2.sub(e,c,this.lastNormalizedMouseXY_);
e=[-e[1],e[0],0];vec3.normalize(e,e);quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],e,2*f),this.rot_)}else if(this.mode_===Camera.mode.SPHERICAL){var f=Geometry.mouseOnUnitSphere(this.lastNormalizedMouseXY_),e=Geometry.mouseOnUnitSphere(c),d=Math.acos(Math.min(1,vec3.dot(f,e))),k=[0,0,0];vec3.normalize(k,vec3.cross(k,f,e));quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],k,2*d),this.rot_)}this.lastNormalizedMouseXY_=c},updateView:function(){var a=this.view_,b=this.transX_,c=this.transY_;this.type_===
Camera.projType.PERSPECTIVE?mat4.lookAt(a,[b,c,this.zoom_],[b,c,0],[0,1,0]):mat4.lookAt(a,[b,c,1E3],[b,c,0],[0,1,0]);b=mat4.create();mat4.fromQuat(b,this.rot_);mat4.mul(a,a,b);this.usePivot_&&(b=this.center_,mat4.translate(a,a,[-b[0],-b[1],-b[2]]))},updateProjection:function(){this.proj_=mat4.create();this.type_===Camera.projType.PERSPECTIVE?mat4.perspective(this.proj_,this.fov_*Math.PI/180,this.width_/this.height_,0.01,1E5):this.updateOrtho()},updateTranslation:function(){this.transX_+=this.moveX_*
this.speed_/400;this.zoom_=Math.max(1E-5,this.zoom_+this.moveZ_*this.speed_/400);this.type_===Camera.projType.ORTHOGRAPHIC&&this.updateOrtho()},translate:function(a,b){this.transX_-=a*this.speed_;this.transY_+=b*this.speed_},zoom:function(a){this.zoom_=Math.max(1E-5,this.zoom_-a*this.speed_);this.type_===Camera.projType.ORTHOGRAPHIC&&this.updateOrtho()},updateOrtho:function(){var a=0.001*Math.abs(this.zoom_);mat4.ortho(this.proj_,-this.width_*a,this.width_*a,-this.height_*a,this.height_*a,-1E4,1E4)},
computePosition:function(){var a=this.view_,b=[-a[12],-a[13],-a[14]],c=mat3.create();mat3.fromMat4(c,a);return vec3.transformMat3(b,b,mat3.transpose(c,c))},reset:function(){this.rot_=quat.create();this.zoom_=0;this.center_=[0,0,0];this.transY_=this.transX_=0},resetViewFront:function(){this.rot_=quat.create()},resetViewTop:function(){this.rot_=quat.rotateX(this.rot_,quat.create(),0.5*Math.PI)},resetViewLeft:function(){this.rot_=quat.rotateY(this.rot_,quat.create(),0.5*-Math.PI)},unproject:function(a,
b,c){var f=this.height_;a=[2*a/this.width_-1,(f-2*b)/f,2*c-1,1];b=mat4.create();vec4.transformMat4(a,a,mat4.invert(b,mat4.mul(b,this.proj_,this.view_)));b=a[3];return[a[0]/b,a[1]/b,a[2]/b]},project:function(a){a=[a[0],a[1],a[2],1];vec4.transformMat4(a,a,this.view_);vec4.transformMat4(a,a,this.proj_);var b=a[3],c=this.height_;return[0.5*(a[0]/b+1)*this.width_,c-0.5*(a[1]/b+1)*c,0.5*(a[2]/b+1)]}};var Files={importOBJ:function(a,b){for(var c=b.vertices_,f=b.triangles_,e=[],d=[],k=a.split("\n"),g=[],h=k.length,l=0;l<h;++l){var m=k[l],m=m.trim();if(m.startsWith("v "))g=m.split(/\s+/),c.push(new Vertex(c.length)),e.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));else if(m.startsWith("f ")){var g=m.split(/\s+/),m=g[1].split("/"),p=g[2].split("/"),n=g[3].split("/"),m=parseInt(m[0],10),q=parseInt(p[0],10),n=parseInt(n[0],10),r=c.length;0>m?(m+=r,q+=r,n+=r):(--m,--q,--n);var p=c[m],s=c[q],
u=c[n],v=f.length;p.tIndices_.push(v);s.tIndices_.push(v);u.tIndices_.push(v);f.push(new Triangle(v));d.push(m,q,n);4<g.length&&(++v,g=parseInt(g[4].split("/")[0],10),0>g?g+=r:--g,q=c[g],p.tIndices_.push(v),u.tIndices_.push(v),q.tIndices_.push(v),f.push(new Triangle(v)),d.push(m,n,g))}}b.vertexArray_=new Float32Array(2*e.length);b.normalArray_=new Float32Array(2*e.length);b.colorArray_=new Float32Array(2*e.length);b.indexArray_=new SculptGL.indexArrayType(2*d.length);b.vertexArray_.set(e);b.indexArray_.set(d);
c=c.length;f=b.colorArray_;for(l=e=0;l<c;++l)e=3*l,f[e]=1,f[e+1]=1,f[e+2]=1},exportOBJ:function(a){var b=a.vertexArray_,c=a.indexArray_,f="s 0\n",e=a.vertices_.length,d=a.triangles_.length;a=1/a.scale_;for(var k=0,g=0,k=0;k<e;++k)g=3*k,f+="v "+b[g]*a+" "+b[g+1]*a+" "+b[g+2]*a+"\n";for(k=0;k<d;++k)g=3*k,f+="f "+(1+c[g])+" "+(1+c[g+1])+" "+(1+c[g+2])+"\n";return f},importSTL:function(a,b){for(var c=a.length,f=new Uint8Array(c),e=0;e<c;++e)f[e]=a[e].charCodeAt()&255;c=new DataView(f.buffer||f);84+50*
c.getUint32(80,!0)===c.byteLength?Files.importBinarySTL(a,b):Files.importAsciiSTL(a,b)},importAsciiSTL:function(a,b){for(var c=b.vertices_,f=b.triangles_,e=[],d=[],k=a.split("\n"),g=[],h=k.length,l={},m=0,p=0,n=g=0,q=0,r=m=0,s=0;s<h;++s)n=k[s],n=n.trim(),n.startsWith("facet")&&(r=f.length,g=k[s+2].split(/\s+/),m=parseFloat(g[1]),p=parseFloat(g[2]),g=parseFloat(g[3]),n=Files.detectNewVertex(l,m,p,g,c,e,r),g=k[s+3].split(/\s+/),m=parseFloat(g[1]),p=parseFloat(g[2]),g=parseFloat(g[3]),q=Files.detectNewVertex(l,
m,p,g,c,e,r),g=k[s+4].split(/\s+/),m=parseFloat(g[1]),p=parseFloat(g[2]),g=parseFloat(g[3]),m=Files.detectNewVertex(l,m,p,g,c,e,r),d.push(n,q,m),f.push(new Triangle(r)),s+=6);b.vertexArray_=new Float32Array(2*e.length);b.normalArray_=new Float32Array(2*e.length);b.indexArray_=new SculptGL.indexArrayType(2*d.length);b.vertexArray_.set(e);b.indexArray_.set(d)},importBinarySTL:function(a,b){for(var c=b.vertices_,f=b.triangles_,e=[],d=[],k=Files.getUint32(a,80),g={},h=0,l=0,m=0,p=0,n=0,h=0,q=96,r=0,s=
0;s<k;++s)r=f.length,h=Files.getFloat32(a,q),l=Files.getFloat32(a,q+4),m=Files.getFloat32(a,q+8),p=Files.detectNewVertex(g,h,l,m,c,e,r),h=Files.getFloat32(a,q+12),l=Files.getFloat32(a,q+16),m=Files.getFloat32(a,q+20),n=Files.detectNewVertex(g,h,l,m,c,e,r),h=Files.getFloat32(a,q+24),l=Files.getFloat32(a,q+28),m=Files.getFloat32(a,q+32),h=Files.detectNewVertex(g,h,l,m,c,e,r),d.push(p,n,h),f.push(new Triangle(r)),q+=50;b.vertexArray_=new Float32Array(2*e.length);b.normalArray_=new Float32Array(2*e.length);
b.indexArray_=new SculptGL.indexArrayType(2*d.length);b.vertexArray_.set(e);b.indexArray_.set(d)},exportPLY:function(a){return Files.exportAsciiPLY(a)},exportAsciiPLY:function(a){var b=a.vertexArray_,c=a.colorArray_,f=a.indexArray_,e=a.vertices_.length,d=a.triangles_.length,k=1/a.scale_,g=0,h=0;a="ply\nformat ascii 1.0\ncomment created by SculptGL\n"+("element vertex "+e+"\n")+"property float x\nproperty float y\nproperty float z\n";a+="property uchar red\nproperty uchar green\nproperty uchar blue\n";
a+="element face "+d+"\n";a+="property list uchar uint vertex_indices\nend_header\n";for(g=0;g<e;++g)h=3*g,a+=b[h]*k+" "+b[h+1]*k+" "+b[h+2]*k+" "+(255*c[h]|0)+" "+(255*c[h+1]|0)+" "+(255*c[h+2]|0)+"\n";for(g=0;g<d;++g)h=3*g,a+="3 "+f[h]+" "+f[h+1]+" "+f[h+2]+"\n";return a},detectNewVertex:function(a,b,c,f,e,d,k){var g=b+"+"+c+"+"+f,h=null,l=0;a.hasOwnProperty(g)?(l=a[g],h=e[l]):(l=e.length,h=new Vertex(l),e.push(h),d.push(b,c,f),a[g]=l);h.tIndices_.push(k);return l},getBytes:function(a,b){return[a[b].charCodeAt(),
a[b+1].charCodeAt(),a[b+2].charCodeAt(),a[b+3].charCodeAt()]},getUint32:function(a,b){var c=Files.getBytes(a,b);return c[0]<<0|c[1]<<8|c[2]<<16|c[3]<<24},getFloat32:function(a,b){var c=Files.getBytes(a,b),f=1-2*(c[3]>>7),e=(c[3]<<1&255|c[2]>>7)-127,c=(c[2]&127)<<16|c[1]<<8|c[0];return 128===e?0!==c?NaN:Infinity*f:-127===e?f*c*Math.pow(2,-149):f*(1+c*Math.pow(2,-23))*Math.pow(2,e)},exportVerold:function(a,b){var c=new FormData;c.append("api_key",b);var f=Files.exportOBJ(a);c.append("model",new Blob([f]),
"model.obj");c.append("title","Model");c.append("description","Imported from SculptGL.");var e=new XMLHttpRequest;e.open("POST","http://studio.verold.com/projects.json");e.addEventListener("load",function(){var a=JSON.parse(e.responseText);console.log(a);a.errors?alert("Verold upload error :\n"+a.errors[0]):alert("Upload success !")},!0);e.send(c)},exportSketchfab:function(a,b){var c=new FormData;c.append("token",b);var f=Files.exportOBJ(a);c.append("fileModel",new Blob([f]));c.append("filenameModel",
"model.obj");var e=new XMLHttpRequest;e.open("POST","https://api.sketchfab.com/v1/models");e.addEventListener("load",function(){var a=JSON.parse(e.responseText);console.log(a);a.success?alert("Upload success !"):alert("Sketchfab upload error :\n"+a.error)},!0);e.send(c)}};var Geometry={normalizedMouse:function(a,b,c,f){return[2*a/c-1,1-2*b/f]},mouseOnUnitSphere:function(a){var b=a[0];a=a[1];var c=1-b*b-a*a,c=0<c?Math.sqrt(c):0,b=[b,a,c];return vec3.normalize(b,b)},intersectionRayTriangle:function(a,b,c,f,e,d,k){var g=[0,0,0];vec3.sub(g,a,c);var h=vec3.dot(g,d),l=vec3.dot(vec3.sub(g,b,c),d);if(0<=h*l)return!1;vec3.scaleAndAdd(k,a,vec3.sub(g,b,a),-h/(l-h));a=[0,0,0];vec3.cross(a,d,vec3.sub(g,f,c));if(0>vec3.dot(a,vec3.sub(g,k,c)))return!1;vec3.cross(a,d,vec3.sub(g,e,
f));if(0>vec3.dot(a,vec3.sub(g,k,f)))return!1;vec3.cross(a,d,vec3.sub(g,c,e));return 0>vec3.dot(a,vec3.sub(g,k,c))?!1:!0},computeTriangleAabb:function(a,b,c,f,e,d,k,g,h,l){var m=Math.min(b,e,g),p=Math.min(c,d,h),n=Math.min(f,k,l);b=Math.max(b,e,g);c=Math.max(c,d,h);f=Math.max(f,k,l);k=a.min_;a=a.max_;k[0]=m;k[1]=p;k[2]=n;a[0]=b;a[1]=c;a[2]=f},normal:function(a,b,c,f,e,d,k,g,h,l){e-=b;d-=c;k-=f;b=g-b;c=h-c;g=l-f;h=l=f=0;f=d*g-k*c;l=k*b-e*g;h=e*c-d*b;e=f*f+l*l+h*h;0!==e&&(e=1/Math.sqrt(e),a[0]=f*e,
a[1]=l*e,a[2]=h*e)},pointInsideTriangle:function(a,b,c,f){var e=[0,0,0];vec3.sub(e,b,c);var d=[0,0,0];vec3.sub(d,b,f);b=[0,0,0];vec3.sub(b,a,c);c=[0,0,0];vec3.sub(c,a,f);f=[0,0,0];a=vec3.len(vec3.cross(f,e,d));e=vec3.len(vec3.cross(f,e,b));d=vec3.len(vec3.cross(f,d,c));b=vec3.len(vec3.cross(f,b,c));return 1E-4>Math.abs(a-(e+d+b))?!0:!1},sphereIntersectTriangle:function(a,b,c,f,e){return Geometry.distanceToSegment(a,c,f)<b||Geometry.distanceToSegment(a,f,e)<b||Geometry.distanceToSegment(a,c,e)<b?!0:
!1},distanceToSegment:function(a,b,c){var f=[0,0,0];vec3.sub(f,a,b);var e=[0,0,0];vec3.sub(e,c,b);var d=vec3.sqrLen(e),d=vec3.dot(f,e)/d;if(0>d)return vec3.sqrLen(f);if(1<d)return vec3.sqrLen(vec3.sub(f,a,c));f[0]=a[0]-b[0]+d*e[0];f[1]=a[1]-b[1]+d*e[1];f[2]=a[2]-b[2]+d*e[2];return vec3.sqrLen(f)},signedAngle2d:function(a,b){var c=a[0],f=a[1],e=b[0],d=b[1];return Math.atan2(c*d-f*e,c*e+f*d)},pointPlaneDistance:function(a,b,c){return vec3.dot(vec3.sub([0,0,0],a,b),c)},mirrorPoint:function(a,b,c){return vec3.sub(a,
a,vec3.scale([0,0,0],c,2*Geometry.pointPlaneDistance(a,b,c)))},vertexOnLine:function(a,b,c){var f=[0,0,0];vec3.sub(f,c,b);c=[0,0,0];a=vec3.dot(f,vec3.sub(c,a,b));return vec3.scaleAndAdd(c,b,f,a/vec3.sqrLen(f))}};function Grid(){this.aabb_=new Aabb;this.size_=this.cellSize_=this.dimZ_=this.dimY_=this.dimX_=0;this.iVerts_=[]}
Grid.prototype={setBoundaries:function(a){var b=[0,0,0];vec3.sub(b,a.max_,a.min_);vec3.scale(b,b,0.1);vec3.sub(a.min_,a.min_,b);vec3.add(a.max_,a.max_,b);this.aabb_=a},init:function(a){this.cellSize_=a;var b=this.aabb_,c=[0,0,0];vec3.sub(c,b.max_,b.min_);var b=Math.ceil(c[0]/a),f=Math.ceil(c[1]/a);a=Math.ceil(c[2]/a);0>=b&&(b=1);0>=f&&(f=1);0>=a&&(a=1);var c=this.size_=1+b*f*a,e=this.iVerts_;e.length=c;for(var d=0;d<c;++d)e[d]=[];this.dimX_=b;this.dimY_=f;this.dimZ_=a},build:function(a,b){for(var c=
a.vertexArray_,f=this.aabb_.min_,e=this.dimX_,d=e*this.dimY_,k=0,g=0,h=0,l=0,h=0,m=this.cellSize_,p=this.size_,n=this.iVerts_,q=b.length,l=0;l<q;++l){var r=b[l],h=3*r,k=Math.floor((c[h]-f[0])/m),g=Math.floor((c[h+1]-f[1])/m),h=Math.floor((c[h+2]-f[2])/m),k=k+g*e+h*d;0>k?k=0:k>=p&&(k=p-1);n[k].push(r)}},getNeighborhood:function(a,b,c){var f=this.aabb_.min_,e=this.cellSize_,d=this.dimX_,k=this.dimY_,g=this.dimZ_,h=d*this.dimY_;a=Math.floor((a-f[0])/e);b=Math.floor((b-f[1])/e);c=Math.floor((c-f[2])/
e);0>a?a=0:a>=d&&(a=d-1);0>b?b=0:b>=k&&(b=k-1);0>c?c=0:c>=g&&(c=g-1);var l=e=f=-1,m=1,p=1,n=1;0>=a&&(f=0);a>=d-1&&(m=0);0>=b&&(e=0);b>=k-1&&(p=0);0>=c&&(l=0);c>=g-1&&(n=0);for(var q=g=k=0,r=this.iVerts_,s=[],k=f;k<=m;++k)for(g=e;g<=p;++g)for(q=l;q<=n;++q)s.push.apply(s,r[a+k+(b+g)*d+(c+q)*h]);return s}};function Mesh(a){this.vertices_=[];this.triangles_=[];this.indexArray_=this.colorArray_=this.normalArray_=this.vertexArray_=null;this.center_=[0,0,0];this.octree_=new Octree;this.matTransform_=mat4.create();this.leavesUpdate_=[];this.render_=new Render(a);this.scale_=1}Mesh.globalScale_=500;Mesh.stateMask_=1;
Mesh.prototype={getTrianglesFromVertices:function(a){for(var b=++Triangle.tagMask_,c=[],f=a.length,e=this.vertices_,d=this.triangles_,k=0;k<f;++k)for(var g=e[a[k]].tIndices_,h=g.length,l=0;l<h;++l){var m=g[l];d[m].tagFlag_!==b&&(c.push(m),d[m].tagFlag_=b)}return c},getVerticesFromTriangles:function(a){for(var b=++Vertex.tagMask_,c=[],f=a.length,e=this.vertices_,d=this.indexArray_,k=0;k<f;++k){var g=3*a[k],h=d[g],l=d[g+1],g=d[g+2];e[h].tagFlag_!==b&&(c.push(h),e[h].tagFlag_=b);e[l].tagFlag_!==b&&(c.push(l),
e[l].tagFlag_=b);e[g].tagFlag_!==b&&(c.push(g),e[g].tagFlag_=b)}return c},expandsTriangles:function(a,b){for(var c=++Triangle.tagMask_,f=a.length,e=this.vertices_,d=this.triangles_,k=this.indexArray_,g=0,h=0,g=0;g<f;++g)d[a[g]].tagFlag_=c;for(g=0;b;){for(--b;g<f;++g){for(var h=3*a[g],l=e[k[h]].tIndices_,m=e[k[h+1]].tIndices_,p=e[k[h+2]].tIndices_,n=l.length,q=m.length,r=p.length,h=0;h<n;++h){var s=d[l[h]];s.tagFlag_!==c&&(s.tagFlag_=c,a.push(l[h]))}for(h=0;h<q;++h)l=d[m[h]],l.tagFlag_!==c&&(l.tagFlag_=
c,a.push(m[h]));for(h=0;h<r;++h)m=d[p[h]],m.tagFlag_!==c&&(m.tagFlag_=c,a.push(p[h]))}g=f;f=a.length}},expandsVertices:function(a,b){for(var c=++Vertex.tagMask_,f=a.length,e=this.vertices_,d=0,k=0,d=0;d<f;++d)e[a[d]].tagFlag_=c;for(d=0;b;){for(--b;d<f;++d)for(var g=e[a[d]].ringVertices_,h=g.length,k=0;k<h;++k){var l=e[g[k]];l.tagFlag_!==c&&(l.tagFlag_=c,a.push(g[k]))}d=f;f=a.length}},computeRingVertices:function(a){var b=++Vertex.tagMask_,c=this.vertices_,f=this.indexArray_,e=c[a];e.ringVertices_.length=
0;for(var d=e.ringVertices_,e=e.tIndices_,k=e.length,g=0;g<k;++g){var h=3*e[g],l=f[h],m=f[h+1],h=f[h+2];l!==a&&c[l].tagFlag_!==b&&(d.push(l),c[l].tagFlag_=b);m!==a&&c[m].tagFlag_!==b&&(d.push(m),c[m].tagFlag_=b);h!==a&&c[h].tagFlag_!==b&&(d.push(h),c[h].tagFlag_=b)}},moveTo:function(a){mat4.translate(this.matTransform_,mat4.create(),vec3.sub(a,a,this.center_))},render:function(a,b){this.render_.render(a,b,this.matTransform_,3*this.triangles_.length,this.center_)},initMesh:function(a,b){var c=this.vertexArray_,
f=this.vertices_.length,e=this.triangles_.length,d=new Aabb;d.set(c[0],c[1],c[2],c[0],c[1],c[2]);for(var k=0,g=0,k=0;k<f;++k)this.computeRingVertices(k),g=3*k,d.expandsWithPoint(c[g],c[g+1],c[g+2]);this.center_=d.computeCenter();for(var k=vec3.dist(d.min_,d.max_),h=this.scale_=Mesh.globalScale_/k,k=0;k<f;++k)g=3*k,c[g]*=h,c[g+1]*=h,c[g+2]*=h;mat4.scale(this.matTransform_,this.matTransform_,[h,h,h]);vec3.scale(d.min_,d.min_,h);vec3.scale(d.max_,d.max_,h);vec3.scale(this.center_,this.center_,h);c=[0,
0,0];vec3.sub(c,d.max_,d.min_);vec3.scale(c,c,0.2);vec3.sub(d.min_,d.min_,c);vec3.add(d.max_,d.max_,c);d.enlargeIfFlat(vec3.length(c));for(k=0;k<e;++k)this.updateTriangleAabbAndNormal(k);for(k=0;k<f;++k)this.updateVertexNormal(k);f=Array(e);for(k=0;k<e;++k)f[k]=k;++Triangle.tagMask_;this.octree_=new Octree;this.octree_.build(this,f,d);this.render_.initBuffers(this.vertexArray_,this.normalArray_,this.colorArray_,this.indexArray_);this.render_.updateShaders(this.render_.shaderType_,a,b)},updateBuffers:function(){this.render_.updateBuffers(this.vertexArray_,
this.normalArray_,this.colorArray_,this.indexArray_)},updateMesh:function(a,b){for(var c=b.length,f=a.length,e=0,e=0;e<f;++e)this.updateTriangleAabbAndNormal(a[e]);this.updateOctree(a);for(e=0;e<c;++e)this.updateVertexNormal(b[e])},updateTriangleAabbAndNormal:function(a){var b=this.vertexArray_,c=this.indexArray_,f=this.triangles_[a];a*=3;var e=3*c[a],d=3*c[a+1],k=3*c[a+2];a=b[e];var c=b[e+1],e=b[e+2],g=b[d],h=b[d+1],d=b[d+2],l=b[k],m=b[k+1],b=b[k+2];Geometry.normal(f.normal_,a,c,e,g,h,d,l,m,b);Geometry.computeTriangleAabb(f.aabb_,
a,c,e,g,h,d,l,m,b)},updateVertexNormal:function(a){for(var b=this.triangles_,c=this.normalArray_,f=this.vertices_[a].tIndices_,e=f.length,d=0,k=0,g=0,h=0;h<e;++h)var l=b[f[h]].normal_,d=d+l[0],k=k+l[1],g=g+l[2];b=1/Math.sqrt(d*d+k*k+g*g);a*=3;c[a]=d*b;c[a+1]=k*b;c[a+2]=g*b},updateOctree:function(a){for(var b=a.length,c=[],f=this.triangles_,e=0,d,e=0;e<b;++e){var k=f[a[e]];d=k.leaf_;if(d.aabbSplit_.pointInside(k.aabb_.computeCenter()))k.aabb_.isInside(d.aabbLoose_)||d.aabbLoose_.expandsWithAabb(k.aabb_);
else if(c.push(a[e]),d=d.iTris_,0<d.length){var g=d[d.length-1],k=k.posInLeaf_;d[k]=g;f[g].posInLeaf_=k;d.pop()}}a=c.length;for(e=0;e<a;++e)if(b=f[c[e]],this.octree_.aabbLoose_.isOutside(b.aabb_)){c=new Aabb;c.setCopy(this.octree_.aabbSplit_.min_,this.octree_.aabbSplit_.max_);e=[0,0,0];vec3.scale(e,vec3.sub(e,c.max_,c.min_),0.2);vec3.sub(c.min_,c.min_,e);vec3.add(c.max_,c.max_,e);d=[];f=f.length;for(e=0;e<f;++e)d.push(e);this.octree_=new Octree;++Triangle.tagMask_;this.octree_.build(this,d,c);this.leavesUpdate_.length=
0;break}else d=b.leaf_,this.octree_.addTriangle(this,b),d===b.leaf_&&(d=d.iTris_,b.posInLeaf_=d.length,d.push(c[e]))},checkLeavesUpdate:function(){Tools.tidy(this.leavesUpdate_);var a=this.leavesUpdate_,b=a.length,c=[],f=Octree.maxTriangles_,e=Octree.maxDepth_;++Triangle.tagMask_;for(var d=0,k=0,d=0;d<b;++d){k=a[d];if(null===k)break;k.iTris_.length?k.iTris_.length>f&&k.depth_<e&&k.constructCells(this):Octree.checkEmptiness(k,c)}Tools.tidy(c);a=c.length;for(d=0;d<a;++d){b=c[d].child_;for(k=0;8>k;++k)b[k]=
null}this.leavesUpdate_.length=0}};function Octree(a,b){this.parent_="undefined"!==typeof a?a:null;this.depth_="undefined"!==typeof b?b:0;this.child_=[];this.aabbLoose_=new Aabb;this.aabbSplit_=new Aabb;this.iTris_=[]}Octree.maxDepth_=8;Octree.maxTriangles_=100;
Octree.prototype={build:function(a,b,c){var f=this.aabbSplit_,e=this.aabbLoose_;f.copy(c);e.copy(c);this.iTris_.length=0;c=this.iTris_;var d=a.triangles_,k=b.length,g=Triangle.tagMask_,h=0,l;if(this.parent_&&this.parent_.child_[7]===this)for(h=0;h<k;++h)l=d[b[h]],l.tagFlag_!==g&&(e.expandsWithAabb(l.aabb_),c.push(b[h]));else for(h=0;h<k;++h)l=d[b[h]],f.pointInside(l.aabb_.computeCenter())&&l.tagFlag_!==g&&(e.expandsWithAabb(l.aabb_),c.push(b[h]));b=c.length;if(b>Octree.maxTriangles_&&this.depth_<
Octree.maxDepth_)this.constructCells(a);else for(h=0;h<b;++h)l=d[c[h]],l.tagFlag_=g,l.leaf_=this,l.posInLeaf_=h},constructCells:function(a){var b=this.child_,c=this.iTris_,f=this.aabbSplit_.min_,e=this.aabbSplit_.max_,d=f[0],k=f[1],g=f[2],h=e[0],l=e[1],m=e[2],p=this.aabbSplit_.computeCenter(),n=p[0],q=p[1],r=p[2],s=0.5*(h-d),u=0.5*(l-k),v=0.5*(m-g),x=this.depth_+1,t=new Aabb;b[0]=new Octree(this,x);b[0].build(a,c,t.setCopy(f,p));b[1]=new Octree(this,x);b[1].build(a,c,t.set(d+s,k,g,n+s,q,r));b[2]=
new Octree(this,x);b[2].build(a,c,t.set(n,q-u,r,h,l-u,m));b[3]=new Octree(this,x);b[3].build(a,c,t.set(d,k,g+v,n,q,r+v));b[4]=new Octree(this,x);b[4].build(a,c,t.set(d,k+u,g,n,q+u,r));b[5]=new Octree(this,x);b[5].build(a,c,t.set(n,q,r-v,h,l,m-v));b[6]=new Octree(this,x);b[6].build(a,c,t.setCopy(p,e));b[7]=new Octree(this,x);b[7].build(a,c,t.set(n-s,q,r,h-s,l,m));this.iTris_.length=0},intersectRay:function(a,b){if(this.aabbLoose_.intersectRay(a,b)){if(this.child_[0]){for(var c=[],f=this.child_,e=0;8>
e;++e){var d=f[e].intersectRay(a,b);c.push.apply(c,d)}return c}return this.iTris_}return[]},intersectSphere:function(a,b,c){if(this.aabbSplit_.intersectSphere(a,b)){if(this.child_[0]){for(var f=[],e=this.child_,d=0;8>d;++d){var k=e[d].intersectSphere(a,b,c);f.push.apply(f,k)}return f}c.push(this);return this.iTris_}return[]},addTriangle:function(a,b){if(this.aabbSplit_.pointInside(b.aabb_.computeCenter())){this.aabbLoose_.expandsWithAabb(b.aabb_);var c=this.child_;if(c[0])for(var f=0;8>f;++f)c[f].addTriangle(a,
b);else b.posInLeaf_=this.iTris_.length,b.leaf_=this,this.iTris_.push(b.id_)}}};Octree.checkEmptiness=function(a,b){var c=a.parent_;if(c){for(var f=c.child_,e=0,e=0;8>e;++e)if(0<f[e].iTris_.length||f[e].child_[0])return;b.push(c);for(e=0;8>e;++e)b.push(f[e]);Octree.checkEmptiness(c,b)}};function Picking(a){this.mesh_=null;this.pickedTriangle_=-1;this.pickedVertices_=[];this.interPoint_=[0,0,0];this.rDisplay_=50;this.rWorldSqr_=0;this.camera_=a;this.eyeDir_=[0,0,0]}
Picking.prototype={intersectionMouseMesh:function(a,b,c,f,e,d){var k=this.camera_.unproject(b,c,0),g=this.camera_.unproject(b,c,1),h=mat4.create();mat4.invert(h,a.matTransform_);vec3.transformMat4(k,k,h);vec3.transformMat4(g,g,h);e&&(Geometry.mirrorPoint(k,e,d),Geometry.mirrorPoint(g,e,d));this.intersectionRayMesh(a,k,g,b,c,f);a=this.eyeDir_;vec3.sub(a,g,k);vec3.normalize(a,a)},intersectionRayMesh:function(a,b,c,f,e,d){this.mesh_=null;this.pickedTriangle_=-1;var k=a.triangles_,g=a.vertexArray_,h=
a.indexArray_,l=[0,0,0];vec3.sub(l,c,b);vec3.normalize(l,l);for(var l=a.octree_.intersectRay(b,[1/l[0],1/l[1],1/l[2]]),m=-1,p=l.length,n=[0,0,0],q=0;q<p;++q){var r=l[q],s=k[r],r=3*r,u=3*h[r],v=3*h[r+1],r=3*h[r+2];if(Geometry.intersectionRayTriangle(b,c,[g[u],g[u+1],g[u+2]],[g[v],g[v+1],g[v+2]],[g[r],g[r+1],g[r+2]],s.normal_,n)&&(s=vec3.sqrDist(b,n),s<m||-1===m))m=s,vec3.copy(this.interPoint_,n),this.pickedTriangle_=l[q]}-1!==this.pickedTriangle_?(this.mesh_=a,this.computeRadiusWorldSq(f,e,d)):this.rWorldSqr_=
0},pickVerticesInSphere:function(a){this.pickedVertices_=[];for(var b=this.mesh_.vertices_,c=this.mesh_.vertexArray_,f=this.mesh_.octree_.intersectSphere(this.interPoint_,a,this.mesh_.leavesUpdate_),f=this.mesh_.getVerticesFromTriangles(f),e=f.length,d=++Vertex.sculptMask_,k=this.pickedVertices_,g=0,h=g=0;h<e;++h){var g=f[h],l=b[g],g=3*g;vec3.sqrDist([c[g],c[g+1],c[g+2]],this.interPoint_)<a&&(l.sculptFlag_=d,k.push(f[h]))}0===this.pickedVertices_.length&&-1!==this.pickedTriangle_&&(a=this.mesh_.indexArray_,
g=3*this.pickedTriangle_,this.pickedVertices_.push(a[g],a[g+1],a[g+2]))},computeRadiusWorldSq:function(a,b,c){var f=[0,0,0];vec3.transformMat4(f,this.interPoint_,this.mesh_.matTransform_);var e=this.camera_.project(f)[2];a=this.camera_.unproject(a+this.rDisplay_*c,b,e);this.rWorldSqr_=vec3.sqrDist(f,a)}};function Render(a){this.gl_=a;this.shaderType_=Render.mode.PHONG;this.reflectionTexUnif_=this.lightPositionUnif_=this.radiusSquaredUnif_=this.centerPickingUnif_=this.normalMatrixUnif_=this.mvMatrixUnif_=this.mvpMatrixUnif_=this.barycenterAttrib_=this.normalAttrib_=this.colorAttrib_=this.vertexAttrib_=this.vertexShader_=this.fragmentShader_=this.shaderProgram_=this.reflectionLoc_=this.indexBuffer_=this.barycenterBuffer_=this.colorBuffer_=this.normalBuffer_=this.vertexBuffer_=null}
Render.mode={PHONG:0,TRANSPARENCY:1,WIREFRAME:2,NORMAL:3,MATERIAL:4};
Render.prototype={updateShaders:function(a,b,c){var f=this.gl_;this.shaderType_=a;f.deleteProgram(this.shaderProgram_);a>=Render.mode.MATERIAL&&(this.reflectionLoc_=this.loadTexture(f,b[a-Render.mode.MATERIAL]));this.initShaders(c)},loadTexture:function(a,b){var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST);
a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);return c},initShaders:function(a){var b=this.gl_;switch(this.shaderType_){case Render.mode.PHONG:this.loadShaders(a.phongVertex,a.phongFragment);break;case Render.mode.WIREFRAME:this.loadShaders(a.wireframeVertex,a.wireframeFragment);break;case Render.mode.TRANSPARENCY:this.loadShaders(a.transparencyVertex,a.transparencyFragment);break;case Render.mode.NORMAL:this.loadShaders(a.normalVertex,a.normalFragment);break;default:this.loadShaders(a.reflectionVertex,
a.reflectionFragment)}a=this.shaderProgram_=b.createProgram();b.attachShader(a,this.vertexShader_);b.attachShader(a,this.fragmentShader_);b.linkProgram(a);b.useProgram(a);this.vertexAttrib_=b.getAttribLocation(this.shaderProgram_,"vertex");this.normalAttrib_=b.getAttribLocation(this.shaderProgram_,"normal");this.shaderType_===Render.mode.WIREFRAME?this.barycenterAttrib_=b.getAttribLocation(this.shaderProgram_,"barycenter"):this.shaderType_!==Render.mode.NORMAL&&(this.colorAttrib_=b.getAttribLocation(this.shaderProgram_,
"color"));this.mvpMatrixUnif_=b.getUniformLocation(a,"mvpMat");this.mvMatrixUnif_=b.getUniformLocation(a,"mvMat");this.normalMatrixUnif_=b.getUniformLocation(a,"nMat");this.centerPickingUnif_=b.getUniformLocation(a,"centerPicking");this.radiusSquaredUnif_=b.getUniformLocation(a,"radiusSquared");this.shaderType_===Render.mode.TRANSPARENCY&&(this.lightPositionUnif_=b.getUniformLocation(a,"lightPos"));this.shaderType_>=Render.mode.MATERIAL&&(this.reflectionTexUnif_=b.getUniformLocation(a,"refTex"));
b.detachShader(a,this.fragmentShader_);b.deleteShader(this.fragmentShader_);b.detachShader(a,this.vertexShader_);b.deleteShader(this.vertexShader_)},loadShaders:function(a,b){var c=this.gl_;this.vertexShader_=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vertexShader_,a);c.compileShader(this.vertexShader_);this.fragmentShader_=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fragmentShader_,b);c.compileShader(this.fragmentShader_)},initBuffers:function(a,b,c,f){var e=this.gl_;this.vertexBuffer_=
e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW);this.normalBuffer_=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);e.bufferData(e.ARRAY_BUFFER,b,e.DYNAMIC_DRAW);this.colorBuffer_=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer_);e.bufferData(e.ARRAY_BUFFER,c,e.DYNAMIC_DRAW);this.indexBuffer_=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW)},
render:function(a,b,c,f,e){var d=this.gl_;d.useProgram(this.shaderProgram_);var k=b.interPoint_;b=b.rWorldSqr_;var g=mat4.create();mat4.mul(g,a.view_,c);c=mat4.create();mat4.mul(c,a.proj_,g);d.enableVertexAttribArray(this.vertexAttrib_);d.bindBuffer(d.ARRAY_BUFFER,this.vertexBuffer_);d.vertexAttribPointer(this.vertexAttrib_,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(this.normalAttrib_);d.bindBuffer(d.ARRAY_BUFFER,this.normalBuffer_);d.vertexAttribPointer(this.normalAttrib_,3,d.FLOAT,!1,0,0);this.shaderType_!==
Render.mode.WIREFRAME&&this.shaderType_!==Render.mode.NORMAL&&(d.enableVertexAttribArray(this.colorAttrib_),d.bindBuffer(d.ARRAY_BUFFER,this.colorBuffer_),d.vertexAttribPointer(this.colorAttrib_,3,d.FLOAT,!1,0,0));d.uniformMatrix4fv(this.mvMatrixUnif_,!1,g);d.uniformMatrix4fv(this.mvpMatrixUnif_,!1,c);d.uniformMatrix3fv(this.normalMatrixUnif_,!1,mat3.normalFromMat4(mat3.create(),g));d.uniform3fv(this.centerPickingUnif_,vec3.transformMat4([0,0,0],k,g));d.uniform1f(this.radiusSquaredUnif_,b);switch(this.shaderType_){case Render.mode.PHONG:this.drawBuffer(f);
break;case Render.mode.TRANSPARENCY:d.depthMask(!1);d.enable(d.BLEND);d.uniform3fv(this.lightPositionUnif_,e);this.drawBuffer(f);d.disable(d.BLEND);d.depthMask(!0);break;case Render.mode.WIREFRAME:d.enableVertexAttribArray(this.barycenterAttrib_);d.bindBuffer(d.ARRAY_BUFFER,this.barycenterBuffer_);d.vertexAttribPointer(this.barycenterAttrib_,3,d.FLOAT,!1,0,0);d.drawArrays(d.TRIANGLES,0,f);break;case Render.mode.NORMAL:this.drawBuffer(f);break;default:d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,
this.reflectionLoc_),d.uniform1i(this.reflectionTexUnif_,0),this.drawBuffer(f)}},drawBuffer:function(a){var b=this.gl_;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);b.drawElements(b.TRIANGLES,a,SculptGL.elementIndexType,0)},updateBuffers:function(a,b,c,f){if(this.shaderType_===Render.mode.WIREFRAME)this.makeWireframeBuffers(a,b,f);else{var e=this.gl_;e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW);e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);
e.bufferData(e.ARRAY_BUFFER,b,e.DYNAMIC_DRAW);e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer_);e.bufferData(e.ARRAY_BUFFER,c,e.DYNAMIC_DRAW);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW)}},makeWireframeBuffers:function(a,b,c){for(var f=this.gl_,e=new Float32Array(3*c.length),d=0,k=0,g=0,d=0;d<c.length;++d)k=3*d,g=3*c[d],e[k]=a[g],e[k+1]=a[g+1],e[k+2]=a[g+2];f.bindBuffer(f.ARRAY_BUFFER,this.vertexBuffer_);f.bufferData(f.ARRAY_BUFFER,e,f.DYNAMIC_DRAW);
a=new Float32Array(3*c.length);for(d=0;d<c.length;++d)k=3*d,g=3*c[d],a[k]=b[g],a[k+1]=b[g+1],a[k+2]=b[g+2];f.bindBuffer(f.ARRAY_BUFFER,this.normalBuffer_);f.bufferData(f.ARRAY_BUFFER,a,f.DYNAMIC_DRAW);b=new Float32Array(3*c.length);for(d=0;d<c.length/3;++d)k=9*d,b[k]=1,b[k+1]=0,b[k+2]=0,b[k+3]=0,b[k+4]=1,b[k+5]=0,b[k+6]=0,b[k+7]=0,b[k+8]=1;this.barycenterBuffer_||(this.barycenterBuffer_=f.createBuffer());f.bindBuffer(f.ARRAY_BUFFER,this.barycenterBuffer_);f.bufferData(f.ARRAY_BUFFER,b,f.DYNAMIC_DRAW)}};function Sculpt(a){this.states_=a;this.mesh_=null;this.intensity_=0.75;this.tool_=Sculpt.tool.BRUSH;this.topo_=Sculpt.topo.SUBDIVISION;this.detailSubdivision_=0.75;this.detailDecimation_=0.1;this.culling_=this.clay_=this.negative_=!1;this.color_=[168,66,66];this.d2Max_=this.d2Min_=0;this.d2Thickness_=0.5;this.d2Move_=0;this.rotateData_={normal:[0,0,0],center:[0,0]};this.rotateDataSym_={normal:[0,0,0],center:[0,0]};this.dragDir_=[0,0,0];this.dragDirSym_=[0,0,0]}
Sculpt.tool={BRUSH:0,INFLATE:1,ROTATE:2,SMOOTH:3,FLATTEN:4,PINCH:5,CREASE:6,DRAG:7,COLOR:8};Sculpt.topo={STATIC:0,SUBDIVISION:1,ADAPTIVE:2};
Sculpt.prototype={setAdaptiveParameters:function(a){this.d2Max_=0.2*a*(1.1-this.detailSubdivision_);this.d2Min_=this.d2Max_/4.2025;this.d2Move_=0.2375*this.d2Min_;this.d2Thickness_=1.1*(4*this.d2Move_+this.d2Max_/3)},sculptStroke:function(a,b,c,f,e){var d=e.ptPlane_,k=e.nPlane_,g=e.picking_,h=e.pickingSym_,l=e.lastMouseX_,m=e.lastMouseY_,p=a-l,n=b-m,q=Math.sqrt(p*p+n*n);e.sumDisplacement_+=q;var r=e.sumDisplacement_,s=0.2*g.rDisplay_,u=q/Math.floor(q/s),p=p/q,n=n/q;e.continuous_?q=r=0:(a=l,b=m);var l=
e.mesh_,m=e.symmetry_,v=this.tool_===Sculpt.tool.DRAG;if(v){s=0;g.mesh_=h.mesh_=l;var x=g.interPoint_,t=h.interPoint_;t[0]=x[0];t[1]=x[1];t[2]=x[2];Geometry.mirrorPoint(t,d,k)}if(r>50*s&&!v)r=0;else if(r>s||0===r){for(s=r=0;s<=q;s+=u){v?this.updateDragDir(l,g,a,b,c):g.intersectionMouseMesh(l,a,b,c);if(!g.mesh_)break;g.pickVerticesInSphere(g.rWorldSqr_);this.sculptMesh(g,f);if(m){v?this.updateDragDir(l,h,a,b,c,d,k):h.intersectionMouseMesh(l,a,b,c,d,k);if(!h.mesh_)break;h.rWorldSqr_=g.rWorldSqr_;h.pickVerticesInSphere(h.rWorldSqr_);
this.sculptMesh(h,f,!0)}a+=p*u;b+=n*u}this.mesh_.updateBuffers()}e.sumDisplacement_=r},sculptMesh:function(a,b,c,f,e,d,k){var g=this.mesh_,h=a.pickedVertices_,l=a.rWorldSqr_,m=a.interPoint_,p=a.eyeDir_;a=g.vertices_;var n=g.getTrianglesFromVertices(h);b*=this.intensity_;this.states_.pushState(n,h);var q=new Topology(this.states_);q.mesh_=g;q.radiusSquared_=l;q.center_=m;this.setAdaptiveParameters(l);switch(this.topo_){case Sculpt.topo.SUBDIVISION:0<this.detailSubdivision_&&(n=q.subdivision(n,this.d2Max_));
0<this.detailDecimation_&&(n=q.decimation(n,this.d2Min_*this.detailDecimation_));break;case Sculpt.topo.ADAPTIVE:n=q.subdivision(n,this.d2Max_),n=q.decimation(n,this.d2Min_)}for(var h=g.getVerticesFromTriangles(n),r=h.length,s=[],u=[],v=Vertex.sculptMask_,x=g.normalArray_,t=p[0],w=p[1],p=p[2],y=0;y<r;++y){var A=h[y];if(a[A].sculptFlag_===v){s.push(A);var z=3*A;0>=x[z]*t+x[z+1]*w+x[z+2]*p&&u.push(A)}}if(0!==u.length)switch(this.culling_&&(s=u),this.tool_){case Sculpt.tool.BRUSH:this.brush(m,s,u,l,
b);break;case Sculpt.tool.INFLATE:this.inflate(m,s,l,b);break;case Sculpt.tool.ROTATE:this.rotate(m,s,l,f,e,d,k,c);break;case Sculpt.tool.SMOOTH:this.smooth(s,b);break;case Sculpt.tool.FLATTEN:this.flatten(m,s,u,l,b);break;case Sculpt.tool.PINCH:this.pinch(m,s,l,b);break;case Sculpt.tool.CREASE:this.crease(m,s,u,l,b);break;case Sculpt.tool.DRAG:this.drag(m,s,l,c);break;case Sculpt.tool.COLOR:this.paint(m,s,l)}this.topo_===Sculpt.topo.ADAPTIVE&&(n=q.adaptTopology(n,this.d2Thickness_),h=g.getVerticesFromTriangles(n));
g.updateMesh(n,h)},brush:function(a,b,c,f,e){var d=this.areaNormal(c);if(d){var k=this.areaCenter(c);c=this.mesh_.vertexArray_;f=Math.sqrt(f);var g=b.length,h=0.1*e*f;e=this.clay_?e:0.3*e;this.negative_&&(h=-h);var l=a[0],m=a[1];a=a[2];for(var p=k[0],n=k[1],k=k[2],q=d[0],r=d[1],d=d[2],s=this.topo_===Sculpt.topo.ADAPTIVE,u=Math.sqrt(this.d2Move_),v=0;v<g;++v){var x=3*b[v],t=c[x],w=c[x+1],y=c[x+2],A=(t-p)*q+(w-n)*r+(y-k)*d,t=t-l,w=w-m,y=y-a,y=Math.sqrt(t*t+w*w+y*y)/f,y=3*y*y*y*y-4*y*y*y+1,y=y*(A*e-
h);s&&y>u&&(y=u);c[x]-=q*y;c[x+1]-=r*y;c[x+2]-=d*y}}},inflate:function(a,b,c,f){var e=this.mesh_,d=e.vertexArray_,e=e.normalArray_,k=b.length;c=Math.sqrt(c);f=0.1*f*c;this.topo_===Sculpt.topo.ADAPTIVE&&(f=Math.min(Math.sqrt(this.d2Move_),f));this.negative_&&(f=-f);var g=a[0],h=a[1];a=a[2];for(var l=0;l<k;++l){var m=3*b[l],p=d[m]-g,n=d[m+1]-h,q=d[m+2]-a,p=Math.sqrt(p*p+n*n+q*q)/c,p=3*p*p*p*p-4*p*p*p+1,p=f*p;d[m]+=e[m]*p;d[m+1]+=e[m+1]*p;d[m+2]+=e[m+2]*p}},startRotate:function(a,b,c,f,e,d,k){var g=
a.camera_.unproject(b,c,0),h=a.camera_.unproject(b,c,1),l=mat4.create();mat4.invert(l,this.mesh_.matTransform_);vec3.transformMat4(g,g,l);vec3.transformMat4(h,h,l);this.initRotateData(a,g,h,b,c,this.rotateData_);k&&(k=[g[0],g[1],g[2]],Geometry.mirrorPoint(k,e,d),h=[h[0],h[1],h[2]],Geometry.mirrorPoint(h,e,d),this.initRotateData(f,k,h,b,c,this.rotateDataSym_),f.rWorldSqr_=a.rWorldSqr_)},initRotateData:function(a,b,c,f,e,d){a.intersectionRayMesh(this.mesh_,b,c,f,e,1);a.mesh_&&(a.pickVerticesInSphere(a.rWorldSqr_),
a=[0,0,0],vec3.sub(a,b,c),d.normal=vec3.normalize(a,a),d.center=[f,e])},rotate:function(a,b,c,f,e,d,k,g){var h=this.rotateData_;g&&(h=this.rotateDataSym_);g=h.center;e=[f-g[0],e-g[1]];if(!(30>vec2.len(e))){vec2.normalize(e,e);h=h.normal;f=[0,0,0,0];d=[d-g[0],k-g[1]];vec2.normalize(d,d);d=Geometry.signedAngle2d(e,d);k=this.mesh_.vertexArray_;c=Math.sqrt(c);g=b.length;e=a[0];for(var l=a[1],m=a[2],p=0;p<g;++p){var n=3*b[p],q=k[n]-e,r=k[n+1]-l,s=k[n+2]-m,q=Math.sqrt(q*q+r*r+s*s)/c,r=[k[n],k[n+1],k[n+
2]];quat.setAxisAngle(f,h,d*(3*q*q*q*q-4*q*q*q+1));vec3.sub(r,r,a);vec3.transformQuat(r,r,f);vec3.add(r,r,a);k[n]=r[0];k[n+1]=r[1];k[n+2]=r[2]}}},smooth:function(a,b){var c=this.mesh_.vertexArray_,f=a.length,e=new Float32Array(3*f);this.laplacianSmooth(a,e);for(var d=this.d2Move_,k=Math.sqrt(d),g=this.topo_===Sculpt.topo.ADAPTIVE,h=0;h<f;++h){var l=3*a[h],m=3*h,p=(e[m]-c[l])*b,n=(e[m+1]-c[l+1])*b,m=(e[m+2]-c[l+2])*b;if(g){var q=p*p+n*n+m*m;q>d&&(q=k/Math.sqrt(q),p*=q,n*=q,m*=q)}c[l]+=p;c[l+1]+=n;
c[l+2]+=m}},flatten:function(a,b,c,f,e){var d=this.areaNormal(c);if(d){var k=this.areaCenter(c);c=this.mesh_.vertexArray_;f=Math.sqrt(f);var g=b.length;e*=0.3;var h=a[0],l=a[1];a=a[2];for(var m=k[0],p=k[1],k=k[2],n=d[0],q=d[1],d=d[2],r=Math.sqrt(this.d2Move_),s=this.topo_===Sculpt.topo.ADAPTIVE,u=0;u<g;++u){var v=3*b[u],x=c[v],t=c[v+1],w=c[v+2],y=(x-m)*n+(t-p)*q+(w-k)*d,x=x-h,t=t-l,w=w-a,w=Math.sqrt(x*x+t*t+w*w)/f,w=3*w*w*w*w-4*w*w*w+1,w=y*e*w;s&&w>r&&(w=r);c[v]-=n*w;c[v+1]-=q*w;c[v+2]-=d*w}}},pinch:function(a,
b,c,f){var e=this.mesh_.vertexArray_;c=Math.sqrt(c);var d=b.length,k=a[0],g=a[1];a=a[2];var h=this.d2Move_,l=Math.sqrt(h),m=this.topo_===Sculpt.topo.ADAPTIVE;f=0.005*f*c;for(var p=0;p<d;++p){var n=3*b[p],q=k-e[n],r=g-e[n+1],s=a-e[n+2],u=Math.sqrt(q*q+r*r+s*s)/c,u=3*u*u*u*u-4*u*u*u+1,u=f*u,q=q*u,r=r*u,s=s*u;m&&(u=q*q+r*r+s*s,u>h&&(u=l/Math.sqrt(u),q*=u,r*=u,s*=u));e[n]+=q;e[n+1]+=r;e[n+2]+=s}},crease:function(a,b,c,f,e){var d=this.areaNormal(c);if(d){c=this.mesh_.vertexArray_;f=Math.sqrt(f);var k=
b.length,g=a[0],h=a[1];a=a[2];var l=d[0],m=d[1],d=d[2],p=this.d2Move_,n=Math.sqrt(p),q=this.topo_===Sculpt.topo.ADAPTIVE;e=0.005*e*f;var r=10;this.negative_&&(r=-10);for(var s=0;s<k;++s){var u=3*b[s],v=g-c[u],x=h-c[u+1],t=a-c[u+2],w=Math.sqrt(v*v+x*x+t*t)/f,w=3*w*w*w*w-4*w*w*w+1,y=e*Math.pow(2-w,-5)*r,w=0.1*w,v=v*w+l*y,x=x*w+m*y,t=t*w+d*y;q&&(w=v*v+x*x+t*t,w>p&&(w=n/Math.sqrt(w),v*=w,x*=w,t*=w));c[u]+=v;c[u+1]+=x;c[u+2]+=t}}},updateDragDir:function(a,b,c,f,e,d,k){var g=b.camera_.unproject(c,f,0),
h=b.camera_.unproject(c,f,1),l=mat4.create();mat4.invert(l,a.matTransform_);vec3.transformMat4(g,g,l);vec3.transformMat4(h,h,l);l=this.dragDir_;d&&(l=this.dragDirSym_,Geometry.mirrorPoint(g,d,k),Geometry.mirrorPoint(h,d,k));d=b.interPoint_;b.interPoint_=Geometry.vertexOnLine(d,g,h);vec3.sub(l,b.interPoint_,d);b.mesh=a;b.computeRadiusWorldSq(c,f,e);a=b.eyeDir_;vec3.sub(a,h,g);vec3.normalize(a,a)},drag:function(a,b,c,f){var e=this.mesh_.vertexArray_,d=b.length;c=Math.sqrt(c);var k=a[0],g=a[1];a=a[2];
var h=f?this.dragDirSym_:this.dragDir_;f=h[0];for(var l=h[1],h=h[2],m=0;m<d;++m){var p=3*b[m],n=e[p]-k,q=e[p+1]-g,r=e[p+2]-a,n=Math.sqrt(n*n+q*q+r*r)/c,n=3*n*n*n*n-4*n*n*n+1;e[p]+=f*n;e[p+1]+=l*n;e[p+2]+=h*n}},paint:function(a,b,c){var f=this.mesh_,e=f.vertexArray_,f=f.colorArray_,d=this.color_;c=Math.sqrt(c);var k=d[0]/255,g=d[1]/255,d=d[2]/255,h=a[0],l=a[1];a=a[2];for(var m=this.intensity_,p=b.length,n=0;n<p;++n){var q=3*b[n],r=e[q]-h,s=e[q+1]-l,u=e[q+2]-a,r=Math.sqrt(r*r+s*s+u*u)/c,r=3*r*r*r*r-
4*r*r*r+1,r=r*m,s=1-r;f[q]=f[q]*s+k*r;f[q+1]=f[q+1]*s+g*r;f[q+2]=f[q+2]*s+d*r}},smoothFlat:function(a,b){var c=this.mesh_,f=c.vertexArray_,c=c.normalArray_,e=a.length,d=new Float32Array(3*e);this.laplacianSmooth(a,d);for(var k=0;k<e;++k){var g=3*a[k],h=f[g],l=f[g+1],m=f[g+2],p=c[g],n=c[g+1],q=c[g+2],r=3*k,s=d[r],u=d[r+1],r=d[r+2],v=p*(s-h)+n*(u-l)+q*(r-m);f[g]+=(s-p*v-h)*b;f[g+1]+=(u-n*v-l)*b;f[g+2]+=(r-q*v-m)*b}},laplacianSmooth:function(a,b){for(var c=this.mesh_,f=c.vertices_,c=c.vertexArray_,e=
a.length,d=0;d<e;++d){var k=3*d,g=f[a[d]],h=g.ringVertices_,l=h.length,m=0,p=0,n=0,q=0,r=0;if(l!==g.tIndices_.length){for(q=g=0;q<l;++q){var r=h[q],s=f[r];s.ringVertices_.length!==s.tIndices_.length&&(r*=3,m+=c[r],p+=c[r+1],n+=c[r+2],++g)}b[k]=m/g;b[k+1]=p/g;b[k+2]=n/g}else{for(q=0;q<l;++q)r=3*h[q],m+=c[r],p+=c[r+1],n+=c[r+2];b[k]=m/l;b[k+1]=p/l;b[k+2]=n/l}}},areaNormal:function(a){for(var b=this.mesh_.normalArray_,c=a.length,f=0,e=0,d=0,k=0;k<c;++k)var g=3*a[k],f=f+b[g],e=e+b[g+1],d=d+b[g+2];a=Math.sqrt(f*
f+e*e+d*d);if(0===a)return null;a=1/a;return[f*a,e*a,d*a]},areaCenter:function(a){for(var b=this.mesh_.vertexArray_,c=a.length,f=0,e=0,d=0,k=0;k<c;++k)var g=3*a[k],f=f+b[g],e=e+b[g+1],d=d+b[g+2];return[f/c,e/c,d/c]}};var Tools={nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},tidy:function(a){a.sort(function(a,b){return a-b});for(var b=a.length,c=0,f=0,c=1;c<b;++c)a[f]!==a[c]&&(a[++f]=a[c]);1<c&&(a.length=f+1)},intersectionArrays:function(a,b){for(var c=0,f=0,e=[],d=a.length,k=b.length;c<d&&f<k;)a[c]<b[f]?c++:a[c]>b[f]?f++:(e.push(a[c]),++c,++f);return e}},Tablet={};Tablet.plugin=document.querySelector("object[type='application/x-wacomtabletplugin']");
Tablet.pressure=function(){var a;Tablet.plugin&&(a=Tablet.plugin.penAPI);return a&&a.pointerType?a.pressure:1};"function"!==typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return this.slice(-a.length)===a});"function"!==typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a});
Array.prototype.rotate=function(){return function(a){a=-a;var b=this.length;a=(Math.abs(a)>=b&&(a%=b),0>a&&(a+=b),a);for(var c,f;a;a=(Math.ceil(b/a)-1)*a-b+(b=a))for(c=b;c>a;f=this[--c],this[c]=this[c-a],this[c-a]=f);return this}}();function Topology(a){this.states_=a;this.mesh_=null;this.center_=[0,0,0];this.verticesMap_={};this.radiusSquared_=0;this.iTrisToDelete_=[];this.iVertsToDelete_=[];this.iVertsDecimated_=[]};Topology.prototype.subdivision=function(a,b){var c=this.mesh_.triangles_,f=0;do f=c.length,a=this.subdivide(a,b);while(f!==c.length);return a};
Topology.prototype.subdivide=function(a,b){var c=this.mesh_,f=c.vertices_,e=c.triangles_,d=f.length,k=e.length,g=[],h=[];this.verticesMap_={};this.initSplit(a,g,h,b);20<g.length&&c.expandsTriangles(g,3);this.states_.pushState(g,c.getVerticesFromTriangles(g));h.length=g.length;this.checkArrayLength(g.length);this.subdivideTriangles(g,h,b);for(var h=[],l=e.length,g=0,g=k;g<l;++g)h.push(g);c.expandsTriangles(h,1);g=h.slice(l-k);this.states_.pushState(g,c.getVerticesFromTriangles(g));a.push.apply(a,h);
for(var k=[],l=a.length,m=++Triangle.tagMask_,g=0;g<l;++g){var p=a[g],n=e[p];n.tagFlag_!==m&&(n.tagFlag_=m,k.push(p))}for(g=e.length;0<h.length;)h=this.fillTriangles(h);for(l=e.length;g<l;++g)k.push(g);e=[];h=f.length;for(g=d;g<h;++g)e.push(g);d=e.length;c.expandsVertices(e,1);g=new Sculpt;g.mesh_=c;g.smoothFlat(e.slice(d),1);for(var c=this.mesh_.vertexArray_,g=this.center_,h=g[0],l=g[1],m=g[2],p=Vertex.sculptMask_,d=e.length,q=0,g=0;g<d;++g){var n=e[g],q=3*n,r=c[q]-h,s=c[q+1]-l,q=c[q+2]-m;f[n].sculptFlag_=
r*r+s*s+q*q<this.radiusSquared_?p:p-1}return k};
Topology.prototype.checkArrayLength=function(a){var b=this.mesh_,c=b.triangles_,f=b.vertexArray_,e=b.normalArray_,d=b.colorArray_,k=b.indexArray_,g=0,h=3*b.vertices_.length+200*a;if(f.length<h){b=new Float32Array(2*h);h=f.length;for(g=0;g<h;++g)b[g]=f[g];this.mesh_.vertexArray_=b;b=new Float32Array(2*h);for(g=0;g<h;++g)b[g]=e[g];this.mesh_.normalArray_=b;b=new Float32Array(2*h);for(g=0;g<h;++g)b[g]=d[g];this.mesh_.colorArray_=b}a=3*c.length+200*a;if(k.length<a){b=new SculptGL.indexArrayType(2*a);
a=k.length;for(g=0;g<a;++g)b[g]=k[g];this.mesh_.indexArray_=b}};Topology.prototype.initSplit=function(a,b,c,f){for(var e=a.length,d=0;d<e;++d){switch(this.findSplit(a[d],f,!0)){case 1:c.push(1);break;case 2:c.push(2);break;case 3:c.push(3);break;default:continue}b.push(a[d])}};
Topology.prototype.findSplit=function(a,b,c){var f=this.mesh_,e=f.vertexArray_,f=f.indexArray_,d=3*a;a=f[d+1];var k=f[d+2],d=3*f[d],f=[e[d],e[d+1],e[d+2]],d=3*a;a=[e[d],e[d+1],e[d+2]];d=3*k;e=[e[d],e[d+1],e[d+2]];if(c&&!Geometry.sphereIntersectTriangle(this.center_,2*this.radiusSquared_,f,a,e)&&!Geometry.pointInsideTriangle(this.center_,f,a,e))return 0;d=[0,0,0];c=vec3.sqrLen(vec3.sub(d,f,a));a=vec3.sqrLen(vec3.sub(d,a,e));f=vec3.sqrLen(vec3.sub(d,f,e));return c>a&&c>f?c>b?1:0:a>f?a>b?2:0:f>b?3:0};
Topology.prototype.subdivideTriangles=function(a,b,c){for(var f=this.mesh_.indexArray_,e=a.length,d=0;d<e;++d){var k=3*a[d];if(1===b[d])this.halfEdgeSplit(a[d],f[k],f[k+1],f[k+2]);else if(2===b[d])this.halfEdgeSplit(a[d],f[k+1],f[k+2],f[k]);else if(3===b[d])this.halfEdgeSplit(a[d],f[k+2],f[k],f[k+1]);else{var g=this.findSplit(a[d],c);1===g?this.halfEdgeSplit(a[d],f[k],f[k+1],f[k+2]):2===g?this.halfEdgeSplit(a[d],f[k+1],f[k+2],f[k]):3===g&&this.halfEdgeSplit(a[d],f[k+2],f[k],f[k+1])}}};
Topology.prototype.halfEdgeSplit=function(a,b,c,f){var e=this.mesh_,d=e.vertices_,k=e.triangles_,g=e.vertexArray_,h=e.normalArray_,l=e.colorArray_,m=e.indexArray_,p=k[a].leaf_,e=p.iTris_,n=d[b],q=d[c],r=d[f],s=this.verticesMap_,u=[Math.min(b,c),Math.max(b,c)],v=!1,x=s[u];void 0===x&&(x=d.length,v=!0,s[u]=x);r.ringVertices_.push(x);var t=3*a;m[t]=b;m[t+1]=x;m[t+2]=f;s=k.length;u=new Triangle(s);t=3*s;m[t]=x;m[t+1]=c;m[t+2]=f;u.stateFlag_=Mesh.stateMask_;r.tIndices_.push(s);q.replaceTriangle(a,s);u.leaf_=
p;u.posInLeaf_=e.length;if(v){var w=d.length,m=new Vertex(w),t=3*b,p=g[t],r=g[t+1],v=g[t+2],y=h[t],A=h[t+1],z=h[t+2],F=l[t],C=l[t+1],D=l[t+2],t=3*c,B=g[t],G=g[t+1],I=g[t+2],J=h[t],K=h[t+1],L=h[t+2],P=l[t],Q=l[t+1],R=l[t+2],t=y*J+A*K+z*L,H=0,H=-1>=t?Math.PI:1<=t?0:Math.acos(t),M=y+J,N=A+K,O=z+L,E=1/Math.sqrt(M*M+N*N+O*O),t=3*w;h[t]=M*E;h[t+1]=N*E;h[t+2]=O*E;l[t]=0.5*(F+P);l[t+1]=0.5*(C+Q);l[t+2]=0.5*(D+R);l=p-B;w=r-G;F=v-I;E=Math.sqrt(l*l+w*w+F*F);0<l*(y-J)+w*(A-K)+F*(z-L)?(g[t]=0.5*(p+B)+0.12*h[t]*
H*E,g[t+1]=0.5*(r+G)+0.12*h[t+1]*H*E,g[t+2]=0.5*(v+I)+0.12*h[t+2]*H*E):(g[t]=0.5*(p+B)-0.12*h[t]*H*E,g[t+1]=0.5*(r+G)-0.12*h[t+1]*H*E,g[t+2]=0.5*(v+I)-0.12*h[t+2]*H*E);m.stateFlag_=Mesh.stateMask_;m.ringVertices_.push(b,c,f);n.replaceRingVertex(c,x);q.replaceRingVertex(b,x);m.tIndices_.push(a,s);d.push(m)}else b=d[x],b.ringVertices_.push(f),b.tIndices_.push(a,s);e.push(s);k.push(u)};
Topology.prototype.fillTriangles=function(a){for(var b=this.mesh_,c=b.vertices_,f=b.triangles_,b=b.indexArray_,e=a.length,d=[],k=0;k<e;++k){var g=a[k],h=3*g,l=b[h],m=b[h+1],h=b[h+2],p=this.verticesMap_,n=p[[Math.min(l,m),Math.max(l,m)]],q=p[[Math.min(m,h),Math.max(m,h)]],p=p[[Math.min(l,h),Math.max(l,h)]],r=c[l].ringVertices_.length,s=c[m].ringVertices_.length,u=c[h].ringVertices_.length,v=0;n?v=q?p?r<s&&r<u?2:s<u?3:1:r<u?2:1:p&&s<u?3:1:q?v=p&&s<r?3:2:p&&(v=3);if(1===v)this.fillTriangle(g,l,m,h,n);
else if(2===v)this.fillTriangle(g,m,h,l,q);else if(3===v)this.fillTriangle(g,h,l,m,p);else continue;d.push(g,f.length-1)}return d};
Topology.prototype.fillTriangle=function(a,b,c,f,e){var d=this.mesh_,k=d.vertices_,g=d.triangles_,d=d.indexArray_,h=3*a;d[h]=b;d[h+1]=e;d[h+2]=f;b=g[a].leaf_;var l=b.iTris_,m=k[c],p=k[f],h=k[e];h.ringVertices_.push(f);p.ringVertices_.push(e);k=g.length;h.tIndices_.push(a,k);var n=new Triangle(k),h=3*k;d[h]=e;d[h+1]=c;d[h+2]=f;n.stateFlag_=Mesh.stateMask_;n.leaf_=b;n.posInLeaf_=l.length;p.tIndices_.push(k);m.replaceTriangle(a,k);l.push(k);g.push(n)};Topology.prototype.decimation=function(a,b){for(var c=0,f=this.radiusSquared_,e=Math.sqrt(f),d=this.mesh_,k=d.triangles_,g=d.vertexArray_,d=d.indexArray_,h=this.center_,l=h[0],m=h[1],h=h[2],p=0;p<a.length;++p){var n=a[p];if(!(0>k[n].tagFlag_)){var c=3*n,q=d[c],r=d[c+1],s=d[c+2],c=3*q,u=g[c],v=g[c+1],x=g[c+2],c=3*r,t=g[c],w=g[c+1],y=g[c+2],c=3*s,A=g[c],z=g[c+1],F=g[c+2],C=(u+t+A)/3-l,D=(v+w+z)/3-m,B=(x+y+F)/3-h,c=C*C+D*D+B*B;if(c<f)c=1;else if(c<2*f)c=(Math.sqrt(c)-e)/(e*Math.SQRT2-e),c=3*c*c*c*c-
4*c*c*c+1;else continue;var C=t-u,D=w-v,B=y-x,G=C*C+D*D+B*B,C=t-A,D=w-z,B=y-F,t=C*C+D*D+B*B,C=u-A,D=v-z,B=x-F,u=C*C+D*D+B*B;G<t&&G<u?G<b*c&&this.decimateTriangles(n,this.findOppositeTriangle(n,q,r),a):t<u?t<b*c&&this.decimateTriangles(n,this.findOppositeTriangle(n,r,s),a):u<b*c&&this.decimateTriangles(n,this.findOppositeTriangle(n,q,s),a)}}this.applyDeletion();return this.getValidModifiedTriangles(this.getValidModifiedVertices(),a)};
Topology.prototype.applyDeletion=function(){var a=this.iTrisToDelete_;Tools.tidy(a);for(var b=0,b=a.length-1;0<=b;--b)this.deleteTriangle(a[b]);a=this.iVertsToDelete_;Tools.tidy(a);for(b=a.length-1;0<=b;--b)this.deleteVertex(a[b])};Topology.prototype.getValidModifiedVertices=function(){for(var a=this.mesh_.vertices_,b=this.iVertsDecimated_,c=b.length,f=a.length,e=++Vertex.tagMask_,d=[],k=0;k<c;++k){var g=b[k];if(!(g>=f)){var h=a[g];h.tagFlag_!==e&&(h.tagFlag_=e,d.push(g))}}return d};
Topology.prototype.getValidModifiedTriangles=function(a,b){var c=this.mesh_,f=c.triangles_,c=c.getTrianglesFromVertices(a);b.push.apply(b,c);for(var c=[],e=b.length,d=f.length,k=++Triangle.tagMask_,g=0;g<e;++g){var h=b[g];if(!(h>=d)){var l=f[h];l.tagFlag_!==k&&(l.tagFlag_=k,c.push(h))}}return c};
Topology.prototype.findOppositeTriangle=function(a,b,c){var f=this.mesh_.vertices_;b=f[b].tIndices_;c=f[c].tIndices_;b.sort(function(a,b){return a-b});c.sort(function(a,b){return a-b});c=Tools.intersectionArrays(b,c);return 2!==c.length?-1:c[0]===a?c[1]:c[0]};
Topology.prototype.decimateTriangles=function(a,b,c){if(-1!==b){var f=this.mesh_.indexArray_,e=3*a,d=f[e],k=f[e+1],g=f[e+2],e=3*b,h=f[e],l=f[e+1],f=f[e+2];d===h?k===f?this.edgeCollapse(a,b,d,k,g,l,c):this.edgeCollapse(a,b,d,g,k,f,c):d===l?k===h?this.edgeCollapse(a,b,d,k,g,f,c):this.edgeCollapse(a,b,d,g,k,h,c):d===f?k===l?this.edgeCollapse(a,b,d,k,g,h,c):this.edgeCollapse(a,b,d,g,k,l,c):k===h?this.edgeCollapse(a,b,g,k,d,l,c):k===l?this.edgeCollapse(a,b,g,k,d,f,c):this.edgeCollapse(a,b,g,k,d,h,c)}};
Topology.prototype.edgeCollapse=function(a,b,c,f,e,d,k){var g=this.mesh_,h=g.vertices_,l=g.triangles_,m=g.vertexArray_,p=g.normalArray_,n=g.colorArray_,q=g.indexArray_,r=h[c],s=h[f],u=r.ringVertices_,v=s.ringVertices_,x=r.tIndices_,t=s.tIndices_,w=h[e],y=h[d];if(u.length===x.length&&v.length===t.length&&w.ringVertices_.length===w.tIndices_.length&&y.ringVertices_.length===y.tIndices_.length)if(this.iVertsDecimated_.push(c,f),this.states_.pushState(x,u),this.states_.pushState(t,v),u.sort(function(a,
b){return a-b}),v.sort(function(a,b){return a-b}),h=0,3<=Tools.intersectionArrays(u,v).length)r.removeTriangle(b),s.removeTriangle(a),w.tIndices_.push(b),y.tIndices_.push(a),h=3*a,q[h]===f?q[h]=d:q[h+1]===f?q[h+1]=d:q[h+2]=d,h=3*b,q[h]===c?q[h]=e:q[h+1]===c?q[h+1]=e:q[h+2]=e,g.computeRingVertices(c),g.computeRingVertices(f),g.computeRingVertices(e),g.computeRingVertices(d),this.cleanUpSingularVertex(c),this.cleanUpSingularVertex(f),this.cleanUpSingularVertex(e),this.cleanUpSingularVertex(d);else{var h=
3*c,A=3*f;e=p[h]+p[A];d=p[h+1]+p[A+1];var z=p[h+2]+p[A+2];n[h]=0.5*(n[h]+n[A]);n[h+1]=0.5*(n[h+1]+n[A+1]);n[h+2]=0.5*(n[h+2]+n[A+2]);n=1/Math.sqrt(e*e+d*d+z*z);e*=n;d*=n;z*=n;p[h]=e;p[h+1]=d;p[h+2]=z;u.push.apply(u,v);r.removeTriangle(a);r.removeTriangle(b);s.removeTriangle(a);s.removeTriangle(b);w.removeTriangle(a);y.removeTriangle(b);x.push.apply(x,t);r=t.length;for(p=p=0;p<r;++p)v=3*t[p],q[v]===f?q[v]=c:q[v+1]===f?q[v+1]=c:q[v+2]=c;g.computeRingVertices(c);r=t=q=0;v=u.length;for(p=0;p<v;++p)w=
u[p],g.computeRingVertices(w),w*=3,q+=m[w],t+=m[w+1],r+=m[w+2];q/=v;t/=v;r/=v;g=e*(q-m[h])+d*(t-m[h+1])+z*(r-m[h+2]);m[h]=q-e*g;m[h+1]=t-d*g;m[h+2]=r-z*g;s.tagFlag_=-1;l[a].tagFlag_=-1;l[b].tagFlag_=-1;this.iVertsToDelete_.push(f);this.iTrisToDelete_.push(a,b);k.push.apply(k,x);this.cleanUpSingularVertex(c)}};
Topology.prototype.deleteTriangle=function(a){var b=0,c=this.mesh_,f=c.vertices_,e=c.triangles_,c=c.indexArray_,d=e[a],k=d.posInLeaf_,d=d.leaf_.iTris_,g=d[d.length-1];a!==g&&(d[k]=g,e[g].posInLeaf_=k);d.pop();k=e.length-1;if(k!==a){var d=e[k],b=3*k,g=c[b],h=c[b+1],b=c[b+2];this.states_.pushState([k],[g,h,b]);d.id_=a;d.leaf_.iTris_[d.posInLeaf_]=a;var l=f[h],m=f[b];f[g].replaceTriangle(k,a);l.replaceTriangle(k,a);m.replaceTriangle(k,a);this.iVertsDecimated_.push(g,h,b);e[a]=d;a*=3;c[a]=g;c[a+1]=h;
c[a+2]=b}e.pop()};
Topology.prototype.deleteVertex=function(a){var b=this.mesh_,c=b.vertices_,f=b.vertexArray_,e=b.normalArray_,d=b.colorArray_,k=b.indexArray_,b=c.length-1;if(a!==b){var g=0,h=c[b],g=3*b,l=f[g],m=f[g+1],p=f[g+2],n=e[g],q=e[g+1],r=e[g+2],s=d[g],u=d[g+1],v=d[g+2],x=this.states_;x.pushState(null,[b]);h.id_=a;for(var t=h.tIndices_,w=h.ringVertices_,y=t.length,A=w.length,z=0,z=0;z<y;++z)g=t[z],x.pushState([g],null),g*=3,k[g]===b?k[g]=a:k[g+1]===b?k[g+1]=a:k[g+2]=a;for(z=0;z<A;++z)g=w[z],k=c[g],x.pushState(null,
[g]),k.replaceRingVertex(b,a);c[a]=h;g=3*a;f[g]=l;f[g+1]=m;f[g+2]=p;e[g]=n;e[g+1]=q;e[g+2]=r;d[g]=s;d[g+1]=u;d[g+2]=v}c.pop()};Topology.prototype.adaptTopology=function(a,b){for(var c=this.mesh_,f=c.triangles_,e=c.vertexArray_,d=this.radiusSquared_,k=c.getVerticesFromTriangles(a),g=k.length,h=[],l=c.vertices_.length,m=0,p=0,m=this.center_,n=m[0],q=m[1],r=m[2],s=0,u=0,m=p=0;m<g;++m){var v=k[m];v>=l||(p=3*v,s=e[p]-n,u=e[p+1]-q,p=e[p+2]-r,s*s+u*u+p*p<d&&h.push(v))}this.checkCollisions(h,b);m=c.getTrianglesFromVertices(this.iVertsDecimated_);a.push.apply(a,m);c=[];e=a.length;d=f.length;++Triangle.tagMask_;k=Triangle.tagMask_;
for(m=0;m<e;++m)g=a[m],g>=d||(h=f[g],h.tagFlag_!==k&&(h.tagFlag_=k,c.push(g)));return c};
Topology.prototype.checkCollisions=function(a,b){var c=this.mesh_,f=c.vertices_,e=c.vertexArray_,d=0;this.iVertsDecimated_=[];this.iTrisToDelete_=[];this.iVertsToDelete_=[];var k=0.25*b,g=new Aabb,h=a.length;0<h&&(d=3*a[0],g.min_=[e[d],e[d+1],e[d+2]],g.max_=[e[d],e[d+1],e[d+2]]);for(var l=0,m=0,l=0;l<h;++l)d=3*a[l],g.expandsWithPoint(e[d],e[d+1],e[d+2]);var p=new Grid;p.setBoundaries(g);p.init(Math.sqrt(k));p.build(c,a);for(l=0;l<h;++l)if(g=a[l],d=f[g],!(0>d.tagFlag_)){var d=d.ringVertices_,n=d.length;
++Vertex.tagMask_;for(m=0;m<n;++m)f[d[m]].tagFlag_=Vertex.tagMask_;for(var d=3*g,q=e[d],r=e[d+1],s=e[d+2],u=p.getNeighborhood(q,r,s),v=u.length,m=0;m<v;++m){var x=u[m];if(g!==x){var t=f[x];if(!(0>t.tagFlag_||t.tagFlag_===Vertex.tagMask_)){var d=3*x,w=q-e[d],y=r-e[d+1],d=s-e[d+2];if(w*w+y*y+d*d<k){n>t.ringVertices_.length?this.vertexJoin(g,x):this.vertexJoin(x,g);break}}}}}this.applyDeletion();k=this.iVertsDecimated_=this.getValidModifiedVertices();h=k.length;e=[];p=Vertex.sculptMask_;for(l=0;l<h;++l)d=
k[l],f[d].sculptFlag_===p&&e.push(d);f=new Sculpt;f.mesh_=c;c.expandsVertices(e,1);f.smooth(e,1)};
Topology.prototype.vertexJoin=function(a,b){var c=this.mesh_,f=c.vertices_,e=f[a],f=f[b],d=e.tIndices_,k=f.tIndices_,g=e.ringVertices_.slice(0),h=f.ringVertices_.slice(0),l=g.length,m=h.length;this.states_.pushState(d,g);this.states_.pushState(k,h);this.states_.pushState(null,[a,b]);d=[];k=[];this.trianglesRotate(e.tIndices_,a,d);if(this.adjustEdgeOrientation(d)&&(this.trianglesRotate(f.tIndices_,b,k),this.adjustEdgeOrientation(k))){g.sort(function(a,b){return a-b});h.sort(function(a,b){return a-
b});var p=Tools.intersectionArrays(g,h);0===p.length?this.connect1Ring(d,k):this.connect1RingCommonVertices(d,k,p);for(d=d=0;d<l;++d)c.computeRingVertices(g[d]);for(d=0;d<m;++d)c.computeRingVertices(h[d]);this.iVertsDecimated_.push(a,b);this.iVertsToDelete_.push(a,b);e.tagFlag_=-1;f.tagFlag_=-1;this.cleanUpNeighborhood(g,h)}};
Topology.prototype.connect1RingCommonVertices=function(a,b,c){var f=this.mesh_,e=f.vertices_,d=f.triangles_,f=a.length,k=b.length,g=c.length,h=0;++Vertex.tagMask_;for(var l=Vertex.tagMask_,h=0;h<g;++h)e[c[h]].tagFlag_=l;for(var g=this.iTrisToDelete_,m=null,p=null,n=0,h=0;h<f;++h)m=e[a[h].v1],p=e[a[h].v2],m.tagFlag_===l&&p.tagFlag_===l&&(n=a[h].t,m.removeTriangle(n),p.removeTriangle(n),d[n].tagFlag_=-1,g.push(n));for(h=0;h<k;++h)m=e[b[h].v1],p=e[b[h].v2],m.tagFlag_===l&&p.tagFlag_===l&&(n=b[h].t,m.removeTriangle(n),
p.removeTriangle(n),d[n].tagFlag_=-1,g.push(n));d=[];g=[];d.push([]);g.push([]);this.matchEdgesCommonVertices(a,b,c[0]);for(h=0;h<f;++h)m=e[a[h].v1],p=e[a[h].v2],(m.tagFlag_!==l||p.tagFlag_!==l)&&d[d.length-1].push(a[h]),p.tagFlag_===l&&0!==d[d.length-1].length&&d.push([]);for(h=0;h<k;++h)m=e[b[h].v1],p=e[b[h].v2],(m.tagFlag_!==l||p.tagFlag_!==l)&&g[g.length-1].push(b[h]),p.tagFlag_===l&&0!==g[g.length-1].length&&g.push([]);0===d[d.length-1].length&&d.pop();0===g[g.length-1].length&&g.pop();b=d.length;
c=g.length-1;for(l=k=e=0;e<b||0<=c;)if(l=k=-1,e<b&&(k=d[e][0].v1),0<=c&&(l=g[c][g[c].length-1].v2),k===l)d[e].length>g[c].length?this.connectLinkedEdges(d[e],g[c]):this.connectLinkedEdges(g[c],d[e]),++e,--c;else for(h=0;h<f;++h)if(m=a[h].v1,m===k){this.connectLoop(d[e]);++e;break}else if(m===l){this.connectLoop(g[c]);--c;break}};
Topology.prototype.connect1Ring=function(a,b){var c=this.mesh_,f=c.vertices_,c=c.indexArray_;this.matchEdgesNearest(a,b);var e=a.length,d=b.length,k=d/e,g=0;e===d&&(g=-1);for(var h=0,l=0,h=0;h<e;++h)l=0,0!==h&&(l=Math.floor(d-k*h)),c[3*a[h].t+2]=b[l].v1,f[b[l].v1].tIndices_.push(a[h].t),l!==g&&(c[3*b[l].t+2]=a[h].v1,f[a[h].v1].tIndices_.push(b[l].t)),g=l};
Topology.prototype.connectLinkedEdges=function(a,b){var c=this.mesh_,f=c.vertices_,e=c.triangles_,c=c.indexArray_,d=a.length,k=b.length,g=b[0],h=g.t;f[g.v1].removeTriangle(h);f[g.v2].removeTriangle(h);var g=b[k-1],l=g.t;f[g.v1].removeTriangle(l);f[g.v2].removeTriangle(l);for(var g=k/d,m=0,p=0,n=0,p=0;p<d;++p)n=Math.floor(k-g*(p+1)),1>n&&(n=1),c[3*a[p].t+2]=b[n].v1,f[b[n].v1].tIndices_.push(a[p].t),n!==m&&n!==k-1&&(c[3*b[n].t+2]=a[p].v1,f[a[p].v1].tIndices_.push(b[n].t)),m=n;e[h].tagFlag_=-1;e[l].tagFlag_=
-1;this.iTrisToDelete_.push(h,l)};Topology.prototype.connectLoop=function(a){var b=this.mesh_,c=b.vertices_,f=b.indexArray_,e=a.length,d=a[0],k=d.t,g=d.v1;c[g].removeTriangle(k);c[d.v2].removeTriangle(k);c=c[g];for(d=1;d<e;++d){var h=a[d].t;f[3*h+2]=g;c.tIndices_.push(h)}b.triangles_[k].tagFlag_=-1;this.iTrisToDelete_.push(k)};
Topology.prototype.trianglesRotate=function(a,b,c){for(var f=this.mesh_.indexArray_,e=a.length,d=0,k=0,g=0,h=0,l=0;l<e;++l)d=3*a[l],k=f[d],g=f[d+1],h=f[d+2],h!==b&&(k===b?(f[d]=g,f[d+1]=h):(f[d+1]=k,f[d]=h),f[d+2]=b),c.push({v1:f[d],v2:f[d+1],t:a[l]})};
Topology.prototype.adjustEdgeOrientation=function(a){for(var b=a.length,c=0,f=-1,e=a[0].v1,d=0,k=0,d=0;d<b-1;d++){c=a[d].v2;f=-1;for(k=d+1;k<b;++k)if(a[k].v1===c)if(a[k].v2!==e)f=k;else{c=a[d+1];a[d+1]=a[k];a[k]=c;++d;d+1<b&&(e=a[d+1].v1);break}if(k===b){if(-1===f)return!1;c=a[d+1];a[d+1]=a[f];a[f]=c}}return!0};
Topology.prototype.matchEdgesCommonVertices=function(a,b,c){for(var f=a.length,e=-1,d=0,d=0;d<f;++d)if(a[d].v1===c){e=d;break}a.rotate(e);a=b.length;e=-1;for(d=0;d<a;++d)if(b[d].v1===c){e=d;break}b.rotate(e)};Topology.prototype.matchEdgesNearest=function(a,b){for(var c=this.mesh_.vertexArray_,f=0,e=3*a[0].v1,d=c[e],k=c[e+1],g=c[e+2],e=3*b[0].v1,h=d-c[e],l=k-c[e+1],e=g-c[e+2],m=h*h+l*l+e*e,p=b.length,n=1;n<p;++n)e=3*b[n].v1,h=d-c[e],l=k-c[e+1],e=g-c[e+2],h=h*h+l*l+e*e,h<m&&(m=h,f=n);b.rotate(f)};
Topology.prototype.cleanUpNeighborhood=function(a,b){for(var c=a.length,f=0,f=0;f<c;++f)this.cleanUpSingularVertex(a[f]);c=b.length;for(f=0;f<c;++f)this.cleanUpSingularVertex(b[f])};
Topology.prototype.cleanUpSingularVertex=function(a){var b=this.mesh_,c=b.vertices_,f=b.vertexArray_,e=b.normalArray_,d=b.colorArray_,k=b.indexArray_,g=c[a];if(!(0>g.tagFlag_)){var h=0,h=3*a,l=f[h],m=f[h+1],p=f[h+2],n=e[h],q=e[h+1],r=e[h+2],s=d[h],u=d[h+1],v=d[h+2];this.states_.pushState(g.tIndices_,g.ringVertices_);this.states_.pushState(null,[a]);if(!this.deleteVertexIfDegenerate(a)){var x=[];this.trianglesRotate(g.tIndices_,a,x);if(this.adjustEdgeOrientation(x)){for(var t=x.length,w=x[0].v1,y=
-1,h=0,h=1;h<t-1;++h)if(x[h].v2===w){y=h;break}if(-1!==y){this.checkArrayLength(1);t=c.length;w=new Vertex(t);w.stateFlag_=Mesh.stateMask_;h=3*t;f[h]=l;f[h+1]=m;f[h+2]=p;e[h]=-n;e[h+1]=-q;e[h+2]=-r;d[h]=s;d[h+1]=u;d[h+2]=v;for(h=0;h<=y;++h)f=x[h].t,w.tIndices_.push(f),g.removeTriangle(f),k[3*f+2]=t;c.push(w);b.computeRingVertices(a);b.computeRingVertices(t);c=w.ringVertices_;k=c.length;for(h=0;h<k;++h)b.computeRingVertices(c[h]);g=g.ringVertices_;c=g.length;for(h=0;h<c;++h)b.computeRingVertices(g[h]);
this.iVertsDecimated_.push(a,t);h=[];h.push(a,t);g=new Sculpt;g.mesh_=b;g.smooth(h,1);this.cleanUpSingularVertex(a);this.cleanUpSingularVertex(t)}}}}};
Topology.prototype.deleteVertexIfDegenerate=function(a){var b=this.mesh_,c=b.vertices_,f=b.triangles_,e=b.indexArray_,d=c[a];if(0>d.tagFlag_)return!0;Tools.tidy(d.tIndices_);var k=d.tIndices_.length,g=0,h=g=0;if(0===k)return d.tagFlag_=-1,this.iVertsToDelete_.push(a),this.iVertsDecimated_.push(a),!0;if(1===k){var k=d.tIndices_[0],g=3*k,l=[];l.push(e[g],e[g+1],e[g+2]);Tools.tidy(l);e=l.length;for(g=0;g<e;++g)h=l[g],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));d.tagFlag_=-1;f[k].tagFlag_=
-1;this.iTrisToDelete_.push(k);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(g=0;g<e;++g)h=l[g],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}if(2===k){k=d.tIndices_[0];g=3*k;l=[];l.push(e[g],e[g+1],e[g+2]);Tools.tidy(l);for(var m=l.length,g=0;g<m;++g)h=l[g],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));var p=d.tIndices_[1],g=3*p,n=[];n.push(e[g],e[g+1],e[g+2]);Tools.tidy(n);e=n.length;for(g=0;g<e;++g)h=n[g],h!==a&&(c[h].removeTriangle(p),b.computeRingVertices(h));
d.tagFlag_=-1;f[k].tagFlag_=-1;f[p].tagFlag_=-1;this.iTrisToDelete_.push(k,p);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(g=0;g<m;++g)h=l[g],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);for(g=0;g<e;++g)h=n[g],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}return!1};function Triangle(a){this.id_=a;this.normal_=[0,0,1];this.aabb_=new Aabb;this.posInLeaf_=this.leaf_=null;this.tagFlag_=1}Triangle.tagMask_=1;Triangle.prototype={clone:function(){var a=new Triangle(this.id_);a.normal_=this.normal_.slice();a.aabb_=this.aabb_.clone();a.leaf_=this.leaf_;a.posInLeaf_=this.posInLeaf_;return a}};function State(){this.nbVerticesState_=this.nbTrianglesState_=0;this.vArState_=[];this.nArState_=[];this.cArState_=[];this.iArState_=[];this.vState_=[];this.tState_=[];this.aabbState_=new Aabb}function States(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}
States.prototype={start:function(){++Mesh.stateMask_;var a=this.undos_;this.firstState_?a.length=0:10<a.length&&(a.shift(),--this.curUndoIndex_);this.firstState_=!1;this.redos_.length=0;if(a.length)for(var b=a.length-1;b!==this.curUndoIndex_;)a.pop(),--b;a.push(new State);this.curUndoIndex_=a.length-1;a=a[this.curUndoIndex_];b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone()},pushState:function(a,b){a&&0<a.length&&this.pushStateTriangles(a);
b&&0<b.length&&this.pushStateVertices(b)},pushStateTriangles:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.iArState_,b=b.tState_,f=this.mesh_,e=f.indexArray_,f=f.triangles_,d=Mesh.stateMask_,k=a.length,g=0;g<k;++g){var h=a[g],l=f[h];l.stateFlag_!==d&&(l.stateFlag_=d,b.push(l.clone()),h*=3,c.push(e[h],e[h+1],e[h+2]))}},pushStateVertices:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.vArState_,f=b.nArState_,e=b.cArState_,b=b.vState_,d=this.mesh_,k=d.vertexArray_,g=d.normalArray_,
h=d.colorArray_,d=d.vertices_,l=Mesh.stateMask_,m=a.length,p=0;p<m;++p){var n=a[p],q=d[n];q.stateFlag_!==l&&(q.stateFlag_=l,b.push(q.clone()),n*=3,c.push(k[n],k[n+1],k[n+2]),f.push(g[n],g[n+1],g[n+2]),e.push(h[n],h[n+1],h[n+2]))}},undo:function(){if(this.undos_.length&&!this.firstState_){var a=new State,b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone();this.pushRedoTriangles(a);this.pushRedoVertices(a);this.pullUndoTriangles();
this.pullUndoVertices();this.recomputeOctree(this.undos_[this.curUndoIndex_].aabbState_);b.updateBuffers();this.redos_.push(a);this.curUndoIndex_?(this.firstState_=!1,--this.curUndoIndex_):this.firstState_=!0}},pushRedoTriangles:function(a){var b=this.mesh_,c=b.indexArray_,f=b.triangles_,e=f.length,b=this.undos_[this.curUndoIndex_],d=b.tState_,k=d.length,g=b.nbTrianglesState_,b=a.iArState_;a=a.tState_;var h=0,l=0;if(g<e){for(h=g;h<e;++h)a.push(f[h].clone());for(h=0;h<k;++h)l=d[h].id_,l<g&&a.push(f[l].clone());
f.length=g}else{f.length=g;for(h=0;h<k;++h)l=d[h].id_,l<e&&a.push(f[l].clone())}f=a.length;b.length=3*f;for(h=e=0;h<f;++h)l=3*a[h].id_,e=3*h,b[e]=c[l],b[e+1]=c[l+1],b[e+2]=c[l+2]},pushRedoVertices:function(a){var b=this.mesh_,c=b.vertexArray_,f=b.normalArray_,e=b.colorArray_,d=b.vertices_,k=d.length,b=this.undos_[this.curUndoIndex_],g=b.vState_,h=g.length,l=b.nbVerticesState_,b=a.vArState_,m=a.nArState_,p=a.cArState_;a=a.vState_;var n=0,q=0;if(l<k){for(n=l;n<k;++n)a.push(d[n].clone());for(n=0;n<h;++n)q=
g[n].id_,q<l&&a.push(d[q].clone());d.length=l}else{d.length=l;for(n=0;n<h;++n)q=g[n].id_,q<k&&a.push(d[q].clone())}d=a.length;b.length=3*d;m.length=3*d;p.length=3*d;for(n=k=0;n<d;++n)q=3*a[n].id_,k=3*n,b[k]=c[q],b[k+1]=c[q+1],b[k+2]=c[q+2],m[k]=f[q],m[k+1]=f[q+1],m[k+2]=f[q+2],p[k]=e[q],p[k+1]=e[q+1],p[k+2]=e[q+2]},pullUndoTriangles:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.indexArray_,b=b.triangles_,f=a.tState_,e=a.iArState_,a=a.nbTrianglesState_,d=f.length,k=0,g=0,h=
0,k=0;k<d;++k)g=f[k],g.id_<a&&(h=g.id_,b[h]=g.clone(),h*=3,g=3*k,c[h]=e[g],c[h+1]=e[g+1],c[h+2]=e[g+2])},pullUndoVertices:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.vertexArray_,f=b.normalArray_,e=b.colorArray_,b=b.vertices_,d=a.vState_,k=a.vArState_,g=a.nArState_,h=a.cArState_,a=a.nbVerticesState_,l=d.length,m=0,p=0,n=0,m=0;m<l;++m)p=d[m],p.id_<a&&(n=p.id_,b[n]=p.clone(),n*=3,p=3*m,c[n]=k[p],c[n+1]=k[p+1],c[n+2]=k[p+2],f[n]=g[p],f[n+1]=g[p+1],f[n+2]=g[p+2],e[n]=h[p],e[n+
1]=h[p+1],e[n+2]=h[p+2])},redo:function(){if(this.redos_.length){var a=this.redos_[this.redos_.length-1],b=this.mesh_;b.triangles_.length=a.nbTrianglesState_;b.vertices_.length=a.nbVerticesState_;this.pullRedoTriangles();this.pullRedoVertices();this.recomputeOctree(a.aabbState_.clone());b.updateBuffers();this.firstState_?this.firstState_=!1:this.curUndoIndex_++;this.redos_.pop()}},pullRedoTriangles:function(){for(var a=this.redos_[this.redos_.length-1],b=a.iArState_,a=a.tState_,c=a.length,f=this.mesh_,
e=f.indexArray_,f=f.triangles_,d=0,k=0,g=0,d=0;d<c;++d)k=a[d],g=k.id_,f[g]=k.clone(),g*=3,k=3*d,e[g]=b[k],e[g+1]=b[k+1],e[g+2]=b[k+2]},pullRedoVertices:function(){for(var a=this.redos_[this.redos_.length-1],b=a.vArState_,c=a.nArState_,f=a.cArState_,a=a.vState_,e=a.length,d=this.mesh_,k=d.vertexArray_,g=d.normalArray_,h=d.colorArray_,d=d.vertices_,l=0,m=0,p=0,l=0;l<e;++l)m=a[l],p=m.id_,d[p]=m.clone(),p*=3,m=3*l,k[p]=b[m],k[p+1]=b[m+1],k[p+2]=b[m+2],g[p]=c[m],g[p+1]=c[m+1],g[p+2]=c[m+2],h[p]=f[m],h[p+
1]=f[m+1],h[p+2]=f[m+2]},recomputeOctree:function(a){for(var b=this.mesh_,c=b.triangles_.length,f=Array(c),e=0;e<c;++e)f[e]=e;++Triangle.tagMask_;b.octree_=new Octree;b.octree_.build(b,f,a)},reset:function(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}};function Vertex(a){this.id_=a;this.tIndices_=[];this.ringVertices_=[];this.stateFlag_=this.sculptFlag_=this.tagFlag_=1}Vertex.tagMask_=1;Vertex.sculptMask_=1;
Vertex.prototype={clone:function(){var a=new Vertex(this.id_);a.tIndices_=this.tIndices_.slice();a.ringVertices_=this.ringVertices_.slice();a.tagFlag_=this.tagFlag_;a.sculptFlag_=this.sculptFlag_;a.stateFlag_=this.stateFlag_;return a},replaceTriangle:function(a,b){for(var c=this.tIndices_,f=c.length,e=0;e<f;++e)if(a===c[e]){c[e]=b;break}},replaceRingVertex:function(a,b){for(var c=this.ringVertices_,f=c.length,e=0;e<f;++e)if(a===c[e]){c[e]=b;break}},removeTriangle:function(a){for(var b=this.tIndices_,
c=b.length,f=0;f<c;++f)if(a===b[f]){b[f]=b[c-1];b.pop();break}},removeRingVertex:function(a){for(var b=this.ringVertices_,c=b.length,f=0;f<c;++f)if(a===b[f]){b[f]=b[c-1];b.pop();break}}};function Gui(a){this.sculptgl_=a;this.ctrlFov_=this.ctrlNbTriangles_=this.ctrlNbVertices_=this.ctrlDetailDecimation_=this.ctrlDetailSubdivision_=this.ctrlIntensity_=this.ctrlNegative_=this.ctrlClay_=this.ctrlContinuous_=this.ctrlSculpt_=this.ctrlShaders_=this.ctrlColor_=null;this.dummyFunc_=function(){}}
Gui.prototype={initGui:function(){var a=new dat.GUI;a.domElement.style.position="absolute";a.domElement.style.height="600px";this.initGeneralGui(a);a=new dat.GUI;this.initEditingGui(a)},initGeneralGui:function(a){var b=this.sculptgl_,c=this,f=a.addFolder("Wacom tablet");f.add(b,"usePenRadius_").name("Pressure radius");f.add(b,"usePenIntensity_").name("Pressure intensity");f.open();f=a.addFolder("Files (import/export)");f.add(b,"resetSphere_").name("Reset sphere");f.add(b,"open_").name("Import (obj, stl)");
f.add(b,"save_").name("Export (obj)");f.add(b,"savePLY_").name("Export (ply)");f.open();f=a.addFolder("Go to Verold !");f.add(b,"keyVerold_").name("API key");f.add(b,"exportVerold_").name("Upload");f=a.addFolder("Go to Sketchfab !");f.add(b,"keySketchfab_").name("API key");f.add(b,"exportSketchfab_").name("Upload");f=a.addFolder("Camera");f.add(b.camera_,"mode_",{Spherical:Camera.mode.SPHERICAL,Plane:Camera.mode.PLANE}).name("Mode").onChange(function(a){b.camera_.mode_=parseInt(a,10)});f.add(b.camera_,
"type_",{Perspective:Camera.projType.PERSPECTIVE,Orthographic:Camera.projType.ORTHOGRAPHIC}).name("Type").onChange(function(a){b.camera_.type_=parseInt(a,10);c.ctrlFov_.__li.hidden=b.camera_.type_===Camera.projType.ORTHOGRAPHIC;b.camera_.updateProjection();b.render()});this.ctrlFov_=f.add(b.camera_,"fov_",10,150).name("Fov");this.ctrlFov_.onChange(function(){b.camera_.updateProjection();b.render()});f.add(b.camera_,"usePivot_").name("Picking pivot").onChange(function(){b.camera_.center_=[0,0,0];b.render()});
f.open();a=a.addFolder("History");a.add(b,"undo_").name("Undo (Ctrl+Z)");a.add(b,"redo_").name("Redo (Ctrl+Y)");a.open()},initEditingGui:function(a){var b=this.sculptgl_,c=this,f=a.addFolder("Sculpt");this.ctrlSculpt_=f.add(b.sculpt_,"tool_",{"Brush (1)":Sculpt.tool.BRUSH,"Inflate (2)":Sculpt.tool.INFLATE,"Rotate (3)":Sculpt.tool.ROTATE,"Smooth (4)":Sculpt.tool.SMOOTH,"Flatten (5)":Sculpt.tool.FLATTEN,"Pinch (6)":Sculpt.tool.PINCH,"Crease (7)":Sculpt.tool.CREASE,"Drag (8)":Sculpt.tool.DRAG,"Paint (9)":Sculpt.tool.COLOR}).name("Tool");
this.ctrlSculpt_.onChange(function(a){b.sculpt_.tool_=parseInt(a,10);a=b.sculpt_.tool_;var d=Sculpt.tool;c.ctrlClay_.__li.hidden=a!==d.BRUSH;c.ctrlNegative_.__li.hidden=a!==d.BRUSH&&a!==d.INFLATE&&a!==d.CREASE;c.ctrlContinuous_.__li.hidden=a===d.ROTATE||a===d.DRAG;c.ctrlIntensity_.__li.hidden=c.ctrlContinuous_.__li.hidden;c.ctrlColor_.__li.hidden=a!==d.COLOR});this.ctrlClay_=f.add(b.sculpt_,"clay_").name("Clay");this.ctrlNegative_=f.add(b.sculpt_,"negative_").name("Negative (N)");this.ctrlContinuous_=
f.add(b,"continuous_").name("Continuous");f.add(b,"symmetry_").name("Symmetry");f.add(b.sculpt_,"culling_").name("Sculpt culling");f.add(b.picking_,"rDisplay_",20,200).name("Radius");this.ctrlIntensity_=f.add(b.sculpt_,"intensity_",0,1).name("Intensity");f.open();f=a.addFolder("Topology");f.add(b.sculpt_,"topo_",{Static:Sculpt.topo.STATIC,Dynamic:Sculpt.topo.SUBDIVISION,"Adaptive (!)":Sculpt.topo.ADAPTIVE}).name("Tool").onChange(function(a){b.sculpt_.topo_=parseInt(a,10);a=b.sculpt_.topo_;var d=Sculpt.topo;
c.ctrlDetailSubdivision_.__li.hidden=a===d.STATIC;c.ctrlDetailDecimation_.__li.hidden=a!==d.SUBDIVISION});this.ctrlDetailSubdivision_=f.add(b.sculpt_,"detailSubdivision_",0,1).name("Subdivision");this.ctrlDetailDecimation_=f.add(b.sculpt_,"detailDecimation_",0,1).name("Decimation");f.open();a=a.addFolder("Mesh");this.ctrlNbVertices_=a.add(this,"dummyFunc_").name("Ver : 0");this.ctrlNbTriangles_=a.add(this,"dummyFunc_").name("Tri : 0");f={Phong:Render.mode.PHONG,Transparency:Render.mode.TRANSPARENCY,
"Wireframe (slow)":Render.mode.WIREFRAME,"Normal screen":Render.mode.NORMAL,Clay:Render.mode.MATERIAL,Chavant:Render.mode.MATERIAL+1,Skin:Render.mode.MATERIAL+2,Drink:Render.mode.MATERIAL+3,"Red velvet":Render.mode.MATERIAL+4,Orange:Render.mode.MATERIAL+5,Bronze:Render.mode.MATERIAL+6,Normal:Render.mode.MATERIAL+7};this.ctrlShaders_=a.add(new Render,"shaderType_",f).name("Shader");this.ctrlShaders_.onChange(function(a){b.mesh_&&(b.mesh_.render_.updateShaders(parseInt(a,10),b.textures_,b.shaders_),
b.mesh_.updateBuffers(),b.render())});this.ctrlColor_=a.addColor(b.sculpt_,"color_").name("Color");a.open()},updateMesh:function(a){a&&(this.ctrlShaders_.object=a.render_,this.ctrlShaders_.updateDisplay(),this.updateMeshInfo(a.vertices_.length,a.triangles_.length))},updateMeshInfo:function(a,b){this.ctrlNbVertices_.name("Ver : "+a);this.ctrlNbTriangles_.name("Tri : "+b)}};function SculptGL(){this.gl_=null;this.mouseButton_=this.sumDisplacement_=this.lastMouseY_=this.lastMouseX_=0;this.cameraTimer_=-1;this.usePenRadius_=!0;this.continuous_=this.symmetry_=this.usePenIntensity_=!1;this.sculptTimer_=-1;this.mouseY_=this.mouseX_=this.pressureIntensity_=this.pressureRadius_=0;this.ptPlane_=[0,0,0];this.nPlane_=[1,0,0];this.states_=new States;this.camera_=new Camera;this.picking_=new Picking(this.camera_);this.pickingSym_=new Picking(this.camera_);this.sculpt_=new Sculpt(this.states_);
this.mesh_=null;this.textures_=[];this.shaders_={};this.sphere_="";this.gui_=new Gui(this);this.resetSphere_=this.resetSphere;this.open_=this.openFile;this.save_=this.saveFile;this.savePLY_=this.saveFileAsPLY;this.undo_=this.onUndo;this.redo_=this.onRedo;this.keyVerold_="";this.exportVerold_=this.exportVerold;this.keySketchfab_="";this.exportSketchfab_=this.exportSketchfab}SculptGL.elementIndexType=0;SculptGL.indexArrayType=Uint16Array;
SculptGL.prototype={start:function(){var a=this;$("#fileopen").change(function(b){a.loadFile(b)});this.initWebGL();this.loadShaders();this.gui_.initGui();this.onWindowResize();this.loadTextures();this.initEvents()},initEvents:function(){var a=this,b=$("#canvas");b.mousedown(function(b){a.onMouseDown(b)});b.mouseup(function(b){a.onMouseUp(b)});b.mousewheel(function(b,f){a.onMouseWheel(b,f)});b.mousemove(function(b){a.onMouseMove(b)});b.mouseout(function(b){a.onMouseOut(b)});b[0].addEventListener("webglcontextlost",
a.onContextLost,!1);b[0].addEventListener("webglcontextrestored",a.onContextRestored,!1);$(window).keydown(function(b){a.onKeyDown(b)});$(window).keyup(function(b){a.onKeyUp(b)});$(window).resize(function(b){a.onWindowResize(b)})},initWebGL:function(){var a={antialias:!1,stencil:!0};try{this.gl_=$("#canvas")[0].getContext("webgl",a)||$("#canvas")[0].getContext("experimental-webgl",a)}catch(b){alert("Could not initialise WebGL.")}if(a=this.gl_)a.getExtension("OES_element_index_uint")?(SculptGL.elementIndexType=
a.UNSIGNED_INT,SculptGL.indexArrayType=Uint32Array):(SculptGL.elementIndexType=a.UNSIGNED_SHORT,SculptGL.indexArrayType=Uint16Array),a.viewportWidth=$(window).width(),a.viewportHeight=$(window).height(),a.clearColor(0.2,0.2,0.2,1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},loadTextures:function(){var a=new Image,b=this;a.onload=function(){b.loadSphere()};a.src="ressources/clay.jpg";var c=new Image;c.src=
"ressources/chavant.jpg";var f=new Image;f.src="ressources/skin.jpg";var e=new Image;e.src="ressources/drink.jpg";var d=new Image;d.src="ressources/redvelvet.jpg";var k=new Image;k.src="ressources/orange.jpg";var g=new Image;g.src="ressources/bronze.jpg";var h=new Image;h.src="ressources/normal.jpg";this.textures_.push(a,c,f,e,d,k,g,h)},loadShaders:function(){var a=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},b=this.shaders_;b.phongVertex=a("shaders/phongVertex.glsl");
b.phongFragment=a("shaders/phongFragment.glsl");b.transparencyVertex=a("shaders/transparencyVertex.glsl");b.transparencyFragment=a("shaders/transparencyFragment.glsl");b.wireframeVertex=a("shaders/wireframeVertex.glsl");b.wireframeFragment=a("shaders/wireframeFragment.glsl");b.normalVertex=a("shaders/normalVertex.glsl");b.normalFragment=a("shaders/normalFragment.glsl");b.reflectionVertex=a("shaders/reflectionVertex.glsl");b.reflectionFragment=a("shaders/reflectionFragment.glsl")},loadSphere:function(){var a=
new XMLHttpRequest;a.open("GET","ressources/sphere.obj",!0);var b=this;a.onload=function(){b.sphere_=this.responseText;b.resetSphere()};a.send(null)},render:function(){var a=this.gl_;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.camera_.updateView();this.mesh_&&this.mesh_.render(this.camera_,this.picking_)},onWindowResize:function(){var a=$(window).width(),b=$(window).height();this.camera_.width_=a;this.camera_.height_=b;$("#canvas").attr("width",a);$("#canvas").attr("height",b);var c=this.gl_;
c.viewportWidth=a;c.viewportHeight=b;c.viewport(0,0,a,b);this.camera_.updateProjection();this.render()},onKeyDown:function(a){a.stopPropagation();var b=a.which;if(a.ctrlKey&&90===b)this.onUndo();else if(a.ctrlKey&&89===b)this.onRedo();else{switch(b){case 49:case 97:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.BRUSH);break;case 50:case 98:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.INFLATE);break;case 51:case 99:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.ROTATE);break;case 52:case 100:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.SMOOTH);
break;case 53:case 101:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.FLATTEN);break;case 54:case 102:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.PINCH);break;case 55:case 103:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.CREASE);break;case 56:case 104:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.DRAG);break;case 57:case 105:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.COLOR);break;case 78:this.gui_.ctrlNegative_.setValue(!this.sculpt_.negative_);break;case 37:case 81:case 65:this.camera_.moveX_=-1;break;case 39:case 68:this.camera_.moveX_=
1;break;case 38:case 90:case 87:this.camera_.moveZ_=-1;break;case 40:case 83:this.camera_.moveZ_=1}var c=this;-1===this.cameraTimer_&&(this.cameraTimer_=setInterval(function(){c.camera_.updateTranslation();c.render()},20))}},onKeyUp:function(a){a.stopPropagation();a.preventDefault();switch(a.which){case 37:case 81:case 65:case 39:case 68:this.camera_.moveX_=0;break;case 38:case 90:case 87:case 40:case 83:this.camera_.moveZ_=0;break;case 70:this.camera_.resetViewFront();this.render();break;case 84:this.camera_.resetViewTop();
this.render();break;case 76:this.camera_.resetViewLeft(),this.render()}-1!==this.cameraTimer_&&(0===this.camera_.moveX_&&0===this.camera_.moveZ_)&&(clearInterval(this.cameraTimer_),this.cameraTimer_=-1)},onMouseDown:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX,c=a.pageY;a=this.mouseButton_=a.which;var f=Tablet.pressure(),e=this.usePenRadius_?f:1,f=this.usePenIntensity_?f:1;if(1===a){if(this.mesh_)if(this.sumDisplacement_=0,this.states_.start(),this.sculpt_.tool_===Sculpt.tool.ROTATE)this.sculpt_.startRotate(this.picking_,
b,c,this.pickingSym_,this.ptPlane_,this.nPlane_,this.symmetry_);else if(this.continuous_&&this.sculpt_.tool_!==Sculpt.tool.DRAG){this.pressureRadius_=e;this.pressureIntensity_=f;this.mouseX_=b;this.mouseY_=c;var d=this;this.sculptTimer_=setInterval(function(){d.sculpt_.sculptStroke(d.mouseX_,d.mouseY_,d.pressureRadius_,d.pressureIntensity_,d);d.render()},20)}else this.sculpt_.sculptStroke(b,c,e,f,this)}else 3===a&&(this.camera_.usePivot_&&this.picking_.intersectionMouseMesh(this.mesh_,b,c,e),this.camera_.start(b,
c,this.picking_))},onMouseUp:function(a){a.stopPropagation();a.preventDefault();this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.mouseButton_=0},onMouseOut:function(){this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.mouseButton_=0},onMouseWheel:function(a,b){a.stopPropagation();a.preventDefault();this.camera_.zoom(b/100);this.render()},onMouseMove:function(a){a.stopPropagation();
a.preventDefault();var b=a.pageX;a=a.pageY;var c=this.mouseButton_,f=this.sculpt_.tool_,e=Tablet.pressure(),d=this.usePenRadius_?e:1,e=this.usePenIntensity_?e:1;this.continuous_&&-1!==this.sculptTimer_?(this.pressureRadius_=d,this.pressureIntensity_=e,this.mouseX_=b,this.mouseY_=a):(this.mesh_&&(1!==c||f!==Sculpt.tool.ROTATE&&f!==Sculpt.tool.DRAG)&&this.picking_.intersectionMouseMesh(this.mesh_,b,a,d),1===c?(f!==Sculpt.tool.ROTATE?this.sculpt_.sculptStroke(b,a,d,e,this):this.picking_.mesh_&&(this.picking_.pickVerticesInSphere(this.picking_.rWorldSqr_),
this.sculpt_.sculptMesh(this.picking_,e,!1,b,a,this.lastMouseX_,this.lastMouseY_),this.symmetry_&&(this.pickingSym_.pickVerticesInSphere(this.pickingSym_.rWorldSqr_),this.sculpt_.sculptMesh(this.pickingSym_,e,!0,this.lastMouseX_,this.lastMouseY_,b,a)),this.mesh_.updateBuffers()),this.gui_.updateMeshInfo(this.mesh_.vertices_.length,this.mesh_.triangles_.length)):3===c?this.camera_.rotate(b,a):2===c&&this.camera_.translate((b-this.lastMouseX_)/3E3,(a-this.lastMouseY_)/3E3),this.lastMouseX_=b,this.lastMouseY_=
a,this.render())},onContextLost:function(){alert("shit happens : context lost")},onContextRestored:function(){alert("context is restored")},loadFile:function(a){a.stopPropagation();a.preventDefault();if(0!==a.target.files.length){a=a.target.files[0];var b=a.name;if(b.endsWith(".obj")||b.endsWith(".stl")){var c=new FileReader,f=this;c.onload=function(a){f.startMeshLoad();b.endsWith(".obj")?Files.importOBJ(a.target.result,f.mesh_):Files.importSTL(a.target.result,f.mesh_);f.endMeshLoad();$("#fileopen").replaceWith($("#fileopen").clone(!0))};
b.endsWith(".obj")?c.readAsText(a):c.readAsBinaryString(a)}}},resetSphere:function(){this.startMeshLoad();Files.importOBJ(this.sphere_,this.mesh_);this.endMeshLoad()},startMeshLoad:function(){this.mesh_=new Mesh(this.gl_);this.states_.reset();this.states_.mesh_=this.mesh_;this.sculpt_.mesh_=this.mesh_;Mesh.stateMask_=1;Vertex.tagMask_=1;Vertex.sculptMask_=1;Triangle.tagMask_=1},endMeshLoad:function(){var a=this.mesh_;a.render_.shaderType_=Render.mode.MATERIAL;this.sculpt_.tool_===Sculpt.tool.COLOR?
(this.gui_.ctrlColor_.__li.hidden=!1,this.gui_.ctrlShaders_.setValue(Render.mode.PHONG)):this.gui_.ctrlColor_.__li.hidden=!0;a.initMesh(this.textures_,this.shaders_);a.moveTo([0,0,0]);var b=vec3.dist(a.octree_.aabbLoose_.max_,a.octree_.aabbLoose_.min_);this.camera_.reset();this.camera_.speed_=b;this.camera_.zoom(-0.4);this.gui_.updateMesh(a);this.render()},openFile:function(){$("#fileopen").trigger("click")},saveFile:function(){if(this.mesh_){var a=[Files.exportOBJ(this.mesh_)],a=new Blob(a,{type:"text/plain;charset=utf-8"});
saveAs(a,"yourMesh.obj")}},saveFileAsPLY:function(){if(this.mesh_){var a=[Files.exportPLY(this.mesh_)],a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.ply")}},exportVerold:function(){this.mesh_&&(""===this.keyVerold_?alert("Please enter a verold API Key."):Files.exportVerold(this.mesh_,this.keyVerold_))},exportSketchfab:function(){this.mesh_&&(""===this.keySketchfab_?alert("Please enter a sketchfab API Key."):Files.exportSketchfab(this.mesh_,this.keySketchfab_))},onUndo:function(){this.states_.undo();
this.render();this.gui_.updateMesh(this.mesh_)},onRedo:function(){this.states_.redo();this.render();this.gui_.updateMesh(this.mesh_)}};
